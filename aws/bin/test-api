#!/usr/bin/env bash
#
# API Testing Helper Script
# Provides quick commands to test the deployed backend API
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# API Configuration
API_BASE_URL="https://api.patrickcmd.dev"
COGNITO_CLIENT_ID="62r2aeiu82mktf5inljmvn2dvb"
COGNITO_USER_POOL_ID="us-east-1_DESdNfOSv"
AWS_PROFILE="patrickcmd"
AWS_REGION="us-east-1"

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

show_help() {
    cat << EOF
API Testing Helper Script

Usage: $(basename "$0") <command> [options]

Commands:
    create-user <username> <email> <password>
        Create a new test user in Cognito

    get-token <username> <password>
        Get authentication token for user

    test-health
        Test health endpoint (no auth)

    test-blogs [token]
        List all blogs (requires token)

    create-blog [token]
        Create a sample blog post (requires token)

    test-projects [token]
        List all projects (requires token)

    enable-docs
        Instructions to enable API documentation

    all-endpoints
        Show all available API endpoints

    -h, --help
        Show this help message

Examples:
    # Create test user
    $0 create-user testuser test@example.com MyPass123!

    # Get token
    TOKEN=\$($0 get-token testuser MyPass123!)

    # Test blogs endpoint
    $0 test-blogs \$TOKEN

    # Create blog
    $0 create-blog \$TOKEN

EOF
}

create_user() {
    local username="$1"
    local email="$2"
    local password="$3"

    print_info "Creating user: $username"

    # Create user
    aws cognito-idp admin-create-user \
        --user-pool-id "$COGNITO_USER_POOL_ID" \
        --username "$username" \
        --user-attributes Name=email,Value="$email" Name=email_verified,Value=true \
        --temporary-password "TempPass123!" \
        --message-action SUPPRESS \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        > /dev/null 2>&1

    # Set permanent password
    aws cognito-idp admin-set-user-password \
        --user-pool-id "$COGNITO_USER_POOL_ID" \
        --username "$username" \
        --password "$password" \
        --permanent \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        > /dev/null 2>&1

    print_success "User created: $username"
    print_info "Email: $email"
    print_info "Password: $password"
}

get_token() {
    local username="$1"
    local password="$2"

    aws cognito-idp initiate-auth \
        --auth-flow USER_PASSWORD_AUTH \
        --client-id "$COGNITO_CLIENT_ID" \
        --auth-parameters "USERNAME=$username,PASSWORD=$password" \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        --query 'AuthenticationResult.IdToken' \
        --output text 2>/dev/null
}

test_health() {
    print_info "Testing health endpoint..."
    response=$(curl -s "$API_BASE_URL/health")
    echo "$response" | jq . 2>/dev/null || echo "$response"
}

test_blogs() {
    local token="${1:-}"

    if [ -z "$token" ]; then
        print_error "Token required. Usage: $0 test-blogs <token>"
        return 1
    fi

    print_info "Fetching blogs..."
    response=$(curl -s -H "Authorization: Bearer $token" "$API_BASE_URL/blogs")
    echo "$response" | jq . 2>/dev/null || echo "$response"
}

create_blog() {
    local token="${1:-}"

    if [ -z "$token" ]; then
        print_error "Token required. Usage: $0 create-blog <token>"
        return 1
    fi

    print_info "Creating sample blog post..."

    response=$(curl -s -X POST \
        -H "Authorization: Bearer $token" \
        -H "Content-Type: application/json" \
        -d '{
            "title": "Test Blog Post",
            "content": "This is a test blog post created via API",
            "author": "API Tester",
            "tags": ["test", "api", "demo"],
            "published": true
        }' \
        "$API_BASE_URL/blogs")

    echo "$response" | jq . 2>/dev/null || echo "$response"

    # Extract blog ID if successful
    blog_id=$(echo "$response" | jq -r '.id' 2>/dev/null)
    if [ "$blog_id" != "null" ] && [ -n "$blog_id" ]; then
        print_success "Blog created with ID: $blog_id"
        print_info "View at: $API_BASE_URL/blogs/$blog_id"
    fi
}

test_projects() {
    local token="${1:-}"

    if [ -z "$token" ]; then
        print_error "Token required. Usage: $0 test-projects <token>"
        return 1
    fi

    print_info "Fetching projects..."
    response=$(curl -s -H "Authorization: Bearer $token" "$API_BASE_URL/projects")
    echo "$response" | jq . 2>/dev/null || echo "$response"
}

enable_docs() {
    cat << EOF

${BLUE}═══════════════════════════════════════════════════════════════${NC}
${BLUE}║           Enable API Documentation                        ║${NC}
${BLUE}═══════════════════════════════════════════════════════════════${NC}

To enable /docs and /redoc endpoints:

${YELLOW}1. Edit vault configuration:${NC}
   cd aws/playbooks
   ansible-vault edit vaults/config.yml --vault-password-file ~/.vault_pass.txt

${YELLOW}2. Change environment to 'development':${NC}
   backend_config:
     environment: "development"  # Change from "production"

${YELLOW}3. Redeploy:${NC}
   cd ../..
   ./aws/bin/backend-sam-deploy

${YELLOW}4. Access documentation:${NC}
   • Swagger UI: ${GREEN}$API_BASE_URL/docs${NC}
   • ReDoc:      ${GREEN}$API_BASE_URL/redoc${NC}
   • OpenAPI:    ${GREEN}$API_BASE_URL/openapi.json${NC}

${RED}⚠️  Remember to change back to 'production' when done!${NC}

EOF
}

show_endpoints() {
    cat << EOF

${BLUE}═══════════════════════════════════════════════════════════════${NC}
${BLUE}║           Available API Endpoints                         ║${NC}
${BLUE}═══════════════════════════════════════════════════════════════${NC}

${YELLOW}Base URL:${NC} $API_BASE_URL

${YELLOW}General:${NC}
  GET  /                      - API information
  GET  /health                - Health check

${YELLOW}Blogs:${NC}
  GET    /blogs               - List all blogs
  POST   /blogs               - Create blog
  GET    /blogs/{id}          - Get blog by ID
  PUT    /blogs/{id}          - Update blog
  DELETE /blogs/{id}          - Delete blog

${YELLOW}Projects:${NC}
  GET    /projects            - List all projects
  POST   /projects            - Create project
  GET    /projects/{id}       - Get project by ID
  PUT    /projects/{id}       - Update project
  DELETE /projects/{id}       - Delete project

${YELLOW}Certifications:${NC}
  GET    /certifications      - List all certifications
  POST   /certifications      - Create certification
  GET    /certifications/{id} - Get certification by ID
  PUT    /certifications/{id} - Update certification
  DELETE /certifications/{id} - Delete certification

${YELLOW}Analytics:${NC}
  POST   /visitors            - Track visitor
  GET    /analytics           - Get analytics (query: ?period=7d)

${YELLOW}Documentation (development mode only):${NC}
  GET    /docs                - Swagger UI
  GET    /redoc               - ReDoc
  GET    /openapi.json        - OpenAPI specification

${GREEN}All endpoints (except /docs, /redoc, /openapi.json) require authentication!${NC}

EOF
}

# Main command processing
case "${1:-help}" in
    create-user)
        if [ $# -ne 4 ]; then
            print_error "Usage: $0 create-user <username> <email> <password>"
            exit 1
        fi
        create_user "$2" "$3" "$4"
        ;;
    get-token)
        if [ $# -ne 3 ]; then
            print_error "Usage: $0 get-token <username> <password>"
            exit 1
        fi
        get_token "$2" "$3"
        ;;
    test-health)
        test_health
        ;;
    test-blogs)
        test_blogs "${2:-}"
        ;;
    create-blog)
        create_blog "${2:-}"
        ;;
    test-projects)
        test_projects "${2:-}"
        ;;
    enable-docs)
        enable_docs
        ;;
    all-endpoints|endpoints)
        show_endpoints
        ;;
    -h|--help|help)
        show_help
        ;;
    *)
        print_error "Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac

#!/usr/bin/env bash
# Frontend Deployment Script for Cloud Resume Challenge
# Wrapper script for Ansible playbook deployment
#
# Usage:
#   ./bin/frontend-deploy              # Deploy with default settings
#   ./bin/frontend-deploy --help       # Show help
#   ./bin/frontend-deploy --validate   # Only validate template
#   ./bin/frontend-deploy --verbose    # Run with verbose output

set -euo pipefail  # Exit on error, undefined variables, and pipe failures

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Script directory
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly AWS_DIR="$(dirname "$SCRIPT_DIR")"
readonly PLAYBOOKS_DIR="$AWS_DIR/playbooks"
readonly PLAYBOOK="$PLAYBOOKS_DIR/frontend-deploy.yml"

# Default values
VERBOSE=""
TAGS=""
CHECK_MODE=""
EXTRA_VARS=""

# Functions
print_info() {
    echo -e "${BLUE}9${NC} $1"
}

print_success() {
    echo -e "${GREEN}${NC} $1"
}

print_error() {
    echo -e "${RED}${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}ï¿½${NC} $1"
}

show_help() {
    cat << EOF
Frontend Deployment Script - Cloud Resume Challenge

Usage:
    $(basename "$0") [OPTIONS]

Options:
    -h, --help              Show this help message
    -v, --verbose           Run with verbose output (-vv for more verbose)
    -vvv                    Run with debug output
    --validate              Only validate CloudFormation template (don't deploy)
    --deploy                Only deploy stack (skip validation)
    --info                  Only show stack information
    --check                 Dry run - show what would be deployed
    --bucket NAME           Override S3 bucket name
    --env ENV               Override environment (dev/staging/prod)
    --profile PROFILE       Override AWS profile

Examples:
    # Deploy with default settings
    $(basename "$0")

    # Deploy with verbose output
    $(basename "$0") --verbose

    # Only validate template
    $(basename "$0") --validate

    # Deploy to different environment
    $(basename "$0") --env staging --bucket my-staging-bucket

    # Dry run
    $(basename "$0") --check

Prerequisites:
    - Ansible installed
    - AWS CLI configured
    - Vault password file at ~/.vault_pass.txt
    - Encrypted vault at playbooks/vaults/config.yml

For more information, see:
    - playbooks/README.md
    - playbooks/QUICKSTART.md
    - playbooks/CLOUDFORMATION_CONFIG.md

EOF
}

check_prerequisites() {
    print_info "Checking prerequisites..."

    # Check if Ansible is installed
    if ! command -v ansible-playbook &> /dev/null; then
        print_error "Ansible is not installed"
        print_info "Install with: pip install ansible"
        exit 1
    fi

    # Check if playbook exists
    if [[ ! -f "$PLAYBOOK" ]]; then
        print_error "Playbook not found: $PLAYBOOK"
        exit 1
    fi

    # Check if vault password file exists
    if [[ ! -f "$HOME/.vault_pass.txt" ]]; then
        print_warning "Vault password file not found at ~/.vault_pass.txt"
        print_info "You will be prompted for the vault password"
    fi

    # Check if AWS CLI is installed
    if ! command -v aws &> /dev/null; then
        print_warning "AWS CLI is not installed (optional but recommended)"
    fi

    print_success "Prerequisites check passed"
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                VERBOSE="-v"
                shift
                ;;
            -vv)
                VERBOSE="-vv"
                shift
                ;;
            -vvv)
                VERBOSE="-vvv"
                shift
                ;;
            --validate)
                TAGS="--tags validate"
                shift
                ;;
            --deploy)
                TAGS="--tags deploy"
                shift
                ;;
            --info)
                TAGS="--tags info"
                shift
                ;;
            --check)
                CHECK_MODE="--check"
                shift
                ;;
            --bucket)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e s3_config.bucket_name=$2"
                    shift 2
                else
                    print_error "Error: --bucket requires a value"
                    exit 1
                fi
                ;;
            --env)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e deployment.environment=$2"
                    shift 2
                else
                    print_error "Error: --env requires a value"
                    exit 1
                fi
                ;;
            --profile)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e aws_config.profile=$2"
                    shift 2
                else
                    print_error "Error: --profile requires a value"
                    exit 1
                fi
                ;;
            *)
                print_error "Unknown option: $1"
                echo ""
                show_help
                exit 1
                ;;
        esac
    done
}

run_deployment() {
    print_info "Starting deployment..."
    echo ""

    # Change to playbooks directory
    cd "$PLAYBOOKS_DIR"

    # Build ansible-playbook command
    local cmd="ansible-playbook frontend-deploy.yml"

    # Add verbose flag if set
    if [[ -n "$VERBOSE" ]]; then
        cmd="$cmd $VERBOSE"
    fi

    # Add tags if set
    if [[ -n "$TAGS" ]]; then
        cmd="$cmd $TAGS"
    fi

    # Add check mode if set
    if [[ -n "$CHECK_MODE" ]]; then
        cmd="$cmd $CHECK_MODE"
    fi

    # Add extra vars if set
    if [[ -n "$EXTRA_VARS" ]]; then
        cmd="$cmd $EXTRA_VARS"
    fi

    print_info "Running: $cmd"
    echo ""

    # Run the ansible-playbook command
    if eval "$cmd"; then
        echo ""
        print_success "Deployment completed successfully!"

        # Show outputs file location if deployment succeeded
        if [[ -z "$TAGS" ]] || [[ "$TAGS" == *"info"* ]] || [[ "$TAGS" == *"deploy"* ]]; then
            echo ""
            print_info "Stack outputs saved to: $AWS_DIR/outputs/frontend-stack-outputs.env"
        fi

        return 0
    else
        echo ""
        print_error "Deployment failed!"
        echo ""
        print_info "Troubleshooting tips:"
        print_info ""
        print_info "1. Check stack failures:"
        print_info "   $SCRIPT_DIR/stack-manager failures"
        print_info ""
        print_info "2. View stack events:"
        print_info "   $SCRIPT_DIR/stack-manager events --limit 30"
        print_info ""
        print_info "3. Check stack status:"
        print_info "   $SCRIPT_DIR/stack-manager status"
        print_info ""
        print_info "4. Delete failed stack:"
        print_info "   $SCRIPT_DIR/stack-manager delete"
        print_info ""
        print_info "5. Review playbook logs above for error details"
        print_info ""
        print_info "6. See troubleshooting guide:"
        print_info "   $PLAYBOOKS_DIR/README.md#troubleshooting"
        echo ""
        return 1
    fi
}

main() {
    # Parse command line arguments
    parse_arguments "$@"

    # Show banner
    echo ""
    echo "TPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPW"
    echo "Q   Cloud Resume Challenge - Frontend Deployment            Q"
    echo "ZPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP]"
    echo ""

    # Check prerequisites
    check_prerequisites
    echo ""

    # Run deployment
    if run_deployment; then
        exit 0
    else
        exit 1
    fi
}

# Run main function
main "$@"

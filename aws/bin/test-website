#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Website Testing Script
# ============================================
# Tests CloudFront distribution and custom domain

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_success() {
    echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
    echo -e "${RED}✗ ${1}${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${1}${NC}"
}

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║           Website Testing - CloudFront + DNS              ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

CLOUDFRONT_DOMAIN="${CLOUDFRONT_DOMAIN:-d3jnyva6fvgm7y.cloudfront.net}"
APEX_DOMAIN="${APEX_DOMAIN:-patrickcmd.dev}"
WWW_DOMAIN="${WWW_DOMAIN:-www.patrickcmd.dev}"

# ============================================
# Test 1: CloudFront Distribution
# ============================================

print_info "Test 1: CloudFront Distribution Direct Access"
echo "  Testing: https://${CLOUDFRONT_DOMAIN}"
echo ""

if curl -sI https://${CLOUDFRONT_DOMAIN} | grep -q "HTTP/2 200"; then
    print_success "CloudFront distribution is accessible"

    # Show cache status
    CACHE_STATUS=$(curl -sI https://${CLOUDFRONT_DOMAIN} | grep -i "x-cache:" | cut -d' ' -f2-)
    print_info "Cache Status: ${CACHE_STATUS}"

    # Show content type
    CONTENT_TYPE=$(curl -sI https://${CLOUDFRONT_DOMAIN} | grep -i "content-type:" | cut -d' ' -f2-)
    print_info "Content Type: ${CONTENT_TYPE}"
else
    print_error "CloudFront distribution is not responding correctly"
fi

echo ""

# ============================================
# Test 2: DNS Resolution
# ============================================

print_info "Test 2: DNS Resolution"
echo ""

# Test apex domain DNS
print_info "Checking DNS for ${APEX_DOMAIN}..."
APEX_DNS=$(dig ${APEX_DOMAIN} +short | head -1)

if [ -n "$APEX_DNS" ]; then
    print_success "DNS resolved: ${APEX_DOMAIN} → ${APEX_DNS}"
else
    print_warning "DNS not yet propagated for ${APEX_DOMAIN}"
    print_info "This can take 1-5 minutes. Try again shortly."
fi

echo ""

# Test www subdomain DNS
print_info "Checking DNS for ${WWW_DOMAIN}..."
WWW_DNS=$(dig ${WWW_DOMAIN} +short | head -1)

if [ -n "$WWW_DNS" ]; then
    print_success "DNS resolved: ${WWW_DOMAIN} → ${WWW_DNS}"
else
    print_warning "DNS not yet propagated for ${WWW_DOMAIN}"
    print_info "This can take 1-5 minutes. Try again shortly."
fi

echo ""

# ============================================
# Test 3: HTTPS Access to Apex Domain
# ============================================

print_info "Test 3: HTTPS Access to Apex Domain"
echo "  Testing: https://${APEX_DOMAIN}"
echo ""

if [ -n "$APEX_DNS" ]; then
    if RESPONSE=$(curl -sI https://${APEX_DOMAIN} 2>&1); then
        if echo "$RESPONSE" | grep -q "HTTP/2 200"; then
            print_success "Apex domain is accessible via HTTPS"

            # Show cache status
            CACHE_STATUS=$(echo "$RESPONSE" | grep -i "x-cache:" | cut -d' ' -f2- || echo "N/A")
            print_info "Cache Status: ${CACHE_STATUS}"
        elif echo "$RESPONSE" | grep -q "HTTP"; then
            STATUS=$(echo "$RESPONSE" | grep "HTTP" | head -1)
            print_warning "Unexpected response: ${STATUS}"
        else
            print_error "Could not connect to ${APEX_DOMAIN}"
            echo "  Error: $RESPONSE"
        fi
    else
        print_error "Connection failed: $RESPONSE"
    fi
else
    print_warning "Skipping (DNS not propagated yet)"
fi

echo ""

# ============================================
# Test 4: WWW Redirect
# ============================================

print_info "Test 4: WWW to Apex Redirect"
echo "  Testing: https://${WWW_DOMAIN} → https://${APEX_DOMAIN}"
echo ""

if [ -n "$WWW_DNS" ]; then
    if RESPONSE=$(curl -sI https://${WWW_DOMAIN} 2>&1); then
        if echo "$RESPONSE" | grep -q "HTTP/2 301"; then
            print_success "WWW redirect is working (301 Moved Permanently)"

            # Show redirect location
            LOCATION=$(echo "$RESPONSE" | grep -i "location:" | cut -d' ' -f2- || echo "N/A")
            print_info "Redirects to: ${LOCATION}"

            if echo "$LOCATION" | grep -q "https://${APEX_DOMAIN}"; then
                print_success "Redirect target is correct"
            else
                print_warning "Redirect target unexpected: ${LOCATION}"
            fi
        elif echo "$RESPONSE" | grep -q "HTTP/2 200"; then
            print_warning "WWW is serving content directly (should redirect with 301)"
        else
            print_error "WWW redirect not working as expected"
            echo "$RESPONSE" | grep "HTTP" | head -3
        fi
    else
        print_error "Connection failed: $RESPONSE"
    fi
else
    print_warning "Skipping (DNS not propagated yet)"
fi

echo ""

# ============================================
# Test 5: SSL/TLS Certificate
# ============================================

print_info "Test 5: SSL/TLS Certificate"
echo ""

if [ -n "$APEX_DNS" ]; then
    print_info "Checking SSL certificate for ${APEX_DOMAIN}..."

    if CERT_INFO=$(echo | openssl s_client -servername ${APEX_DOMAIN} -connect ${APEX_DOMAIN}:443 2>/dev/null | openssl x509 -noout -subject -dates 2>/dev/null); then
        print_success "SSL certificate is valid"

        SUBJECT=$(echo "$CERT_INFO" | grep "subject=" | cut -d'=' -f2-)
        EXPIRY=$(echo "$CERT_INFO" | grep "notAfter=" | cut -d'=' -f2-)

        print_info "Subject: ${SUBJECT}"
        print_info "Expires: ${EXPIRY}"
    else
        print_warning "Could not retrieve SSL certificate information"
    fi
else
    print_warning "Skipping (DNS not propagated yet)"
fi

echo ""

# ============================================
# Summary
# ============================================

echo "╔════════════════════════════════════════════════════════════╗"
echo "║                      Test Summary                          ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo ""

if [ -n "$APEX_DNS" ] && [ -n "$WWW_DNS" ]; then
    print_success "All DNS records propagated"
    print_info "Your website should be fully accessible at:"
    echo "  • https://${APEX_DOMAIN}"
    echo "  • https://${WWW_DOMAIN} (redirects to apex)"
    echo ""
    print_info "Open in browser:"
    echo "  https://${APEX_DOMAIN}"
else
    print_warning "DNS propagation still in progress"
    print_info "Run this script again in 1-2 minutes"
    print_info "Or check propagation status:"
    echo "  https://www.whatsmydns.net/#A/${APEX_DOMAIN}"
fi

echo ""

print_info "CloudFront direct access (always works):"
echo "  https://${CLOUDFRONT_DOMAIN}"
echo ""

#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Amazon Cognito User Pool Setup Script
# ============================================
# This script creates and configures Amazon Cognito User Pool
# for backend API authentication with owner-only access

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
PLAYBOOKS_DIR="${PROJECT_ROOT}/playbooks"
OUTPUTS_DIR="${PROJECT_ROOT}/outputs"

# Default values
VAULT_PASSWORD_FILE="${VAULT_PASSWORD_FILE:-$HOME/.vault_pass.txt}"
VERBOSITY=""

# Function to print colored messages
print_info() {
    echo -e "${BLUE}9 ${1}${NC}"
}

print_success() {
    echo -e "${GREEN} ${1}${NC}"
}

print_error() {
    echo -e "${RED} ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}� ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "TPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPW"
    echo "Q        Amazon Cognito User Pool Setup Script              Q"
    echo "ZPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP]"
    echo ""
}

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

Sets up Amazon Cognito User Pool for backend API authentication.

This script will:
  - Create Cognito User Pool with password policy
  - Create User Pool App Client with JWT configuration
  - Create owner account with temporary password
  - Configure email settings (Cognito default or SES)
  - Save configuration to aws/outputs/

OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Verbose output (-v, -vv, -vvv for more verbosity)
    --vault-password-file   Path to vault password file
                           (default: ~/.vault_pass.txt)

EXAMPLES:
    # Basic setup
    $(basename "$0")

    # With verbose output
    $(basename "$0") --verbose

    # With custom vault password file
    $(basename "$0") --vault-password-file /path/to/vault_pass.txt

PREREQUISITES:
    1. Ansible installed (pip install ansible)
    2. AWS CLI configured with credentials
    3. Vault configuration file (vaults/config.yml) with cognito_config section
    4. Vault password file (~/.vault_pass.txt)

VAULT CONFIGURATION:
    Before running this script, ensure your vault (vaults/config.yml) contains:

    cognito_config:
      user_pool_name: portfolio-api-user-pool
      user_pool_client_name: portfolio-frontend-client
      owner_email: your-email@example.com
      owner_name: Your Full Name
      owner_role: owner
      use_ses_email: false
      id_token_validity: 3600
      access_token_validity: 3600
      refresh_token_validity: 2592000
      mfa_configuration: OPTIONAL
      password_minimum_length: 12
      password_require_uppercase: true
      password_require_lowercase: true
      password_require_numbers: true
      password_require_symbols: true

    Edit vault with:
      ansible-vault edit vaults/config.yml --vault-password-file ~/.vault_pass.txt

OUTPUT FILES:
    " aws/outputs/cognito-config.env - Environment variables format
    " aws/outputs/cognito-config.json - JSON format with JWT config
    " aws/outputs/README.md - Security instructions

SECURITY WARNING:
    � The output files contain sensitive credentials including:
      " User Pool IDs
      " Client IDs
      " Temporary password for owner account

    Best Practices:
      1. Immediately copy the temporary password to a password manager
      2. Delete or secure the output files after extracting credentials
      3. Never commit these files to version control
      4. Use environment variables or AWS Parameter Store in production

WHAT GETS CREATED:
    1. Cognito User Pool
       " Custom password policy (12+ chars, mixed case, numbers, symbols)
       " Custom 'role' attribute for authorization
       " Email verification enabled
       " Account recovery via email
       " Optional MFA support

    2. User Pool App Client
       " JWT token configuration (ID: 1h, Access: 1h, Refresh: 30d)
       " Auth flows: USER_PASSWORD_AUTH, REFRESH_TOKEN_AUTH, USER_SRP_AUTH
       " Token revocation enabled

    3. Owner Account
       " Pre-verified email
       " Temporary password (must change on first login)
       " Custom role attribute (role=owner)

    4. User Pool Domain (Optional)
       " Cognito hosted UI domain
       " Format: portfolio-api-XXXXXXXX.auth.REGION.amazoncognito.com

NEXT STEPS:
    After running this script:
      1. Save the temporary password to a password manager
      2. Copy configuration to backend/.env:
           cp aws/outputs/cognito-config.env backend/.env
      3. Update SAM template.yaml with JWT Authorizer config
      4. Login and change password on first use
      5. Delete the output files after copying credentials

TROUBLESHOOTING:
    " Vault password incorrect
      � Check ~/.vault_pass.txt has correct password

    " User Pool already exists
      � Delete existing pool first:
        aws cognito-idp list-user-pools --max-results 10
        aws cognito-idp delete-user-pool --user-pool-id POOL_ID

    " AWS credentials not configured
      � Run: aws configure --profile YOUR_PROFILE

    " Missing vault configuration
      � Edit vault: ansible-vault edit vaults/config.yml

For more information, see:
    aws/playbooks/README.md#running-the-cognito-setup-playbook

EOF
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -v|--verbose)
            if [[ "$VERBOSITY" == "" ]]; then
                VERBOSITY="-v"
            elif [[ "$VERBOSITY" == "-v" ]]; then
                VERBOSITY="-vv"
            else
                VERBOSITY="-vvv"
            fi
            shift
            ;;
        -vv)
            VERBOSITY="-vv"
            shift
            ;;
        -vvv)
            VERBOSITY="-vvv"
            shift
            ;;
        --vault-password-file)
            VAULT_PASSWORD_FILE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            echo ""
            usage
            ;;
    esac
done

print_header

# ============================================
# Prerequisites Check
# ============================================

print_info "Checking prerequisites..."
echo ""

# Check if ansible is installed
if ! command -v ansible-playbook &> /dev/null; then
    print_error "Ansible is not installed"
    print_info "Install with: pip install ansible"
    exit 1
fi
print_success "Ansible found"

# Check if AWS CLI is installed
if ! command -v aws &> /dev/null; then
    print_error "AWS CLI is not installed"
    print_info "Install from: https://aws.amazon.com/cli/"
    exit 1
fi
print_success "AWS CLI found"

# Check if vault password file exists
if [[ ! -f "$VAULT_PASSWORD_FILE" ]]; then
    print_error "Vault password file not found: $VAULT_PASSWORD_FILE"
    print_info "Create it with: echo 'your-password' > ~/.vault_pass.txt && chmod 600 ~/.vault_pass.txt"
    exit 1
fi
print_success "Vault password file found"

# Check if playbook exists
PLAYBOOK_FILE="${PLAYBOOKS_DIR}/setup-cognito.yml"
if [[ ! -f "$PLAYBOOK_FILE" ]]; then
    print_error "Playbook not found: $PLAYBOOK_FILE"
    exit 1
fi
print_success "Playbook found"

# Check if vault config exists
VAULT_CONFIG="${PLAYBOOKS_DIR}/vaults/config.yml"
if [[ ! -f "$VAULT_CONFIG" ]]; then
    print_error "Vault configuration not found: $VAULT_CONFIG"
    print_info "Copy from example: cp vaults/config.example.yml vaults/config.yml"
    exit 1
fi
print_success "Vault configuration found"

echo ""

# ============================================
# Display Warning
# ============================================

print_warning "IMPORTANT: This script will create AWS resources"
print_info "Resources that will be created:"
echo "  - Cognito User Pool (with password policy and custom attributes)"
echo "  - User Pool App Client (with JWT configuration)"
echo "  - Owner user account (with temporary password)"
echo "  - User Pool Domain (optional)"
echo ""

print_warning "Security Notice:"
echo "  - A temporary password will be generated for the owner account"
echo "  - This password will be displayed and saved to output files"
echo "  - You MUST save this password securely (password manager)"
echo "  - You MUST change the password on first login"
echo "  - Output files contain sensitive credentials"
echo ""

print_info "Output files will be saved to:"
echo "  - ${OUTPUTS_DIR}/cognito-config.env"
echo "  - ${OUTPUTS_DIR}/cognito-config.json"
echo "  - ${OUTPUTS_DIR}/README.md"
echo ""

# ============================================
# Confirmation
# ============================================

read -p "$(echo -e ${YELLOW}Continue with Cognito setup? [y/N]: ${NC})" -n 1 -r
echo ""

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    print_info "Setup cancelled"
    exit 0
fi

echo ""

# ============================================
# Run Playbook
# ============================================

print_info "Creating Cognito User Pool..."
echo ""

# Build ansible command
ANSIBLE_CMD="ansible-playbook"
ANSIBLE_CMD="$ANSIBLE_CMD $PLAYBOOK_FILE"
ANSIBLE_CMD="$ANSIBLE_CMD --vault-password-file=$VAULT_PASSWORD_FILE"

# Add verbosity
if [[ "$VERBOSITY" != "" ]]; then
    ANSIBLE_CMD="$ANSIBLE_CMD $VERBOSITY"
fi

# Change to playbooks directory
cd "$PLAYBOOKS_DIR"

# Run the playbook
if eval "$ANSIBLE_CMD"; then
    echo ""
    print_success "Cognito User Pool created successfully!"
    echo ""

    # ============================================
    # Display Output Files
    # ============================================

    print_info "Configuration files saved:"
    echo ""

    if [[ -f "${OUTPUTS_DIR}/cognito-config.env" ]]; then
        print_success "Environment variables: ${OUTPUTS_DIR}/cognito-config.env"
        print_warning "This file contains the temporary password!"
    fi

    if [[ -f "${OUTPUTS_DIR}/cognito-config.json" ]]; then
        print_success "JSON configuration: ${OUTPUTS_DIR}/cognito-config.json"
    fi

    if [[ -f "${OUTPUTS_DIR}/README.md" ]]; then
        print_success "Security instructions: ${OUTPUTS_DIR}/README.md"
    fi

    echo ""

    # ============================================
    # Extract and Display Key Information
    # ============================================

    print_info "Quick Reference:"
    echo ""

    if [[ -f "${OUTPUTS_DIR}/cognito-config.env" ]]; then
        # Extract key values (safely)
        USER_POOL_ID=$(grep "^COGNITO_USER_POOL_ID=" "${OUTPUTS_DIR}/cognito-config.env" | cut -d'=' -f2)
        CLIENT_ID=$(grep "^COGNITO_CLIENT_ID=" "${OUTPUTS_DIR}/cognito-config.env" | cut -d'=' -f2)
        OWNER_EMAIL=$(grep "^OWNER_EMAIL=" "${OUTPUTS_DIR}/cognito-config.env" | cut -d'=' -f2)

        if [[ -n "$USER_POOL_ID" ]]; then
            echo "  User Pool ID: ${USER_POOL_ID}"
        fi
        if [[ -n "$CLIENT_ID" ]]; then
            echo "  Client ID: ${CLIENT_ID}"
        fi
        if [[ -n "$OWNER_EMAIL" ]]; then
            echo "  Owner Email: ${OWNER_EMAIL}"
        fi
        echo ""
    fi

    # ============================================
    # Next Steps
    # ============================================

    print_warning "CRITICAL: Save the temporary password NOW!"
    echo ""

    print_info "Next Steps:"
    echo "  1. Open ${OUTPUTS_DIR}/cognito-config.env"
    echo "  2. Copy the TEMPORARY_PASSWORD to your password manager"
    echo "  3. Copy configuration to backend/.env:"
    echo "       cp ${OUTPUTS_DIR}/cognito-config.env backend/.env"
    echo "  4. Update SAM template.yaml with JWT Authorizer config"
    echo "       (see cognito-config.json for values)"
    echo "  5. Login and change password on first use"
    echo "  6. Delete the output files after copying credentials:"
    echo "       rm ${OUTPUTS_DIR}/cognito-config.env"
    echo "       rm ${OUTPUTS_DIR}/cognito-config.json"
    echo ""

    print_info "Test authentication:"
    echo "  # List user pools"
    echo "  aws cognito-idp list-user-pools --max-results 10"
    echo ""
    echo "  # Describe user pool"
    echo "  aws cognito-idp describe-user-pool --user-pool-id ${USER_POOL_ID:-YOUR_POOL_ID}"
    echo ""
    echo "  # List users"
    echo "  aws cognito-idp list-users --user-pool-id ${USER_POOL_ID:-YOUR_POOL_ID}"
    echo ""

    print_info "View output files:"
    echo "  cat ${OUTPUTS_DIR}/cognito-config.env"
    echo "  cat ${OUTPUTS_DIR}/cognito-config.json"
    echo ""

else
    echo ""
    print_error "Cognito setup failed"
    print_info "Check the error messages above"
    echo ""
    print_info "Common issues:"
    echo "  - Vault password incorrect"
    echo "  - AWS credentials not configured"
    echo "  - User Pool name already exists"
    echo "  - Missing cognito_config in vault"
    echo ""
    print_info "Troubleshooting:"
    echo "  1. Verify vault password: ansible-vault view vaults/config.yml"
    echo "  2. Check AWS credentials: aws sts get-caller-identity"
    echo "  3. List existing user pools: aws cognito-idp list-user-pools --max-results 10"
    echo "  4. Edit vault config: ansible-vault edit vaults/config.yml"
    echo ""
    exit 1
fi

print_success "Done! =�"
echo ""
print_warning "Remember to save the temporary password and delete the output files!"

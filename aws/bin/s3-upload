#!/usr/bin/env bash
set -euo pipefail

# ============================================
# S3 Upload Script
# ============================================
# This script builds and uploads the frontend to S3
# Part of the Cloud Resume Challenge

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
PLAYBOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../playbooks" && pwd)"
PLAYBOOK_FILE="${PLAYBOOK_DIR}/s3-upload.yml"
VAULT_PASSWORD_FILE="${HOME}/.vault_pass.txt"
VERBOSE=""
MODE="production"
ACTION="all"

# Function to print colored messages
print_info() {
    echo -e "${BLUE}ℹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
    echo -e "${RED}✗ ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║   Cloud Resume Challenge - S3 Upload                       ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
}

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

Build and upload React + Vite frontend to S3 bucket.

OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Enable verbose output (-v, -vv, -vvv for more verbosity)
    --build                 Only build the frontend (don't upload)
    --upload                Only upload to S3 (requires existing build)
    --clean                 Clean build artifacts
    --dev                   Build in development mode
    --prod                  Build in production mode (default)
    --vault-password-file   Path to vault password file (default: ~/.vault_pass.txt)

EXAMPLES:
    # Build and upload (default)
    $(basename "$0")

    # Build and upload with verbose output
    $(basename "$0") --verbose

    # Only build (don't upload)
    $(basename "$0") --build

    # Only upload (requires existing build)
    $(basename "$0") --upload

    # Build in development mode
    $(basename "$0") --dev

    # Clean build artifacts
    $(basename "$0") --clean

    # Very verbose output
    $(basename "$0") -vvv

ENVIRONMENT VARIABLES:
    VAULT_PASSWORD_FILE     Override vault password file location

For more information, see:
    - aws/playbooks/s3-upload.yml
    - aws/bin/README.md

EOF
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -v|--verbose)
            if [[ -z "$VERBOSE" ]]; then
                VERBOSE="-v"
            else
                VERBOSE="${VERBOSE}v"
            fi
            shift
            ;;
        -vv)
            VERBOSE="-vv"
            shift
            ;;
        -vvv)
            VERBOSE="-vvv"
            shift
            ;;
        --build)
            ACTION="build"
            shift
            ;;
        --upload)
            ACTION="upload"
            shift
            ;;
        --clean)
            ACTION="clean"
            shift
            ;;
        --dev|--development)
            MODE="development"
            shift
            ;;
        --prod|--production)
            MODE="production"
            shift
            ;;
        --vault-password-file)
            VAULT_PASSWORD_FILE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            usage
            ;;
    esac
done

# Override with environment variable if set
if [[ -n "${VAULT_PASSWORD_FILE:-}" ]]; then
    VAULT_PASSWORD_FILE="${VAULT_PASSWORD_FILE}"
fi

# ============================================
# Pre-flight checks
# ============================================

print_header

print_info "Checking prerequisites..."

# Check if Ansible is installed
if ! command -v ansible-playbook &> /dev/null; then
    print_error "ansible-playbook is not installed"
    print_info "Install with: pip install ansible"
    exit 1
fi

# Check if Node.js is installed
if ! command -v node &> /dev/null; then
    print_error "Node.js is not installed"
    print_info "Install from: https://nodejs.org/"
    exit 1
fi

# Check if npm is installed
if ! command -v npm &> /dev/null; then
    print_error "npm is not installed"
    print_info "Install from: https://nodejs.org/"
    exit 1
fi

# Check if playbook exists
if [[ ! -f "$PLAYBOOK_FILE" ]]; then
    print_error "Playbook not found: $PLAYBOOK_FILE"
    exit 1
fi

# Check if vault password file exists
if [[ ! -f "$VAULT_PASSWORD_FILE" ]]; then
    print_error "Vault password file not found: $VAULT_PASSWORD_FILE"
    print_info "Create it with: echo 'your-vault-password' > ~/.vault_pass.txt && chmod 600 ~/.vault_pass.txt"
    exit 1
fi

print_success "Prerequisites check passed"
echo ""

# ============================================
# Run the deployment
# ============================================

print_info "Starting ${ACTION}..."
echo ""

# Build the ansible-playbook command
ANSIBLE_CMD="ansible-playbook ${PLAYBOOK_FILE}"
ANSIBLE_CMD="${ANSIBLE_CMD} --vault-password-file ${VAULT_PASSWORD_FILE}"

# Add extra vars
ANSIBLE_CMD="${ANSIBLE_CMD} --extra-vars build_mode=${MODE}"

# Add tags based on action
if [[ "$ACTION" != "all" ]]; then
    ANSIBLE_CMD="${ANSIBLE_CMD} --tags ${ACTION}"
fi

# Add verbosity
if [[ -n "$VERBOSE" ]]; then
    ANSIBLE_CMD="${ANSIBLE_CMD} ${VERBOSE}"
fi

# Show the command being run (if verbose)
if [[ -n "$VERBOSE" ]]; then
    print_info "Running: ${ANSIBLE_CMD}"
    echo ""
fi

# Run the playbook
if eval "$ANSIBLE_CMD"; then
    echo ""
    print_success "Operation completed successfully!"
    echo ""

    # Show next steps based on action
    if [[ "$ACTION" == "build" ]]; then
        print_info "Next steps:"
        echo "  1. Review the build in frontend/dist/"
        echo "  2. Upload to S3: ./bin/s3-upload --upload"
    elif [[ "$ACTION" == "upload" ]]; then
        print_info "Next steps:"
        echo "  1. Test your website"
        echo "  2. Check CloudFront (if configured)"
    elif [[ "$ACTION" == "all" ]]; then
        print_info "Next steps:"
        echo "  1. Test your website at the S3 URL"
        echo "  2. View stack outputs: ./bin/stack-manager outputs"
    fi
    echo ""
else
    echo ""
    print_error "Operation failed!"
    echo ""
    print_info "Troubleshooting:"
    echo "  1. Check build errors in frontend directory"
    echo "  2. Verify AWS credentials: aws s3 ls --profile <profile>"
    echo "  3. Check S3 bucket exists: ./bin/stack-manager status"
    echo "  4. Review Ansible logs in playbooks/ansible.log"
    echo "  5. Run with -vvv for detailed output"
    echo ""
    exit 1
fi

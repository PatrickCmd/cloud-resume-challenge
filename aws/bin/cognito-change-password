#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Cognito Password Change Script
# ============================================
# This script helps change the temporary password
# to a permanent password for the owner account

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
OUTPUTS_DIR="${PROJECT_ROOT}/outputs"

# Function to print colored messages
print_info() {
    echo -e "${BLUE}ℹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
    echo -e "${RED}✗ ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║        Cognito Password Change Script                    ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
}

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

Change Cognito user password (first login or reset).

This script supports two methods:
  1. Admin set password (for first-time setup or admin reset)
  2. User change password (for user-initiated password change)

OPTIONS:
    -h, --help              Show this help message
    -u, --username EMAIL    Username (email)
    -p, --new-password PWD  New password
    --admin                 Use admin set password (default)
    --user                  Use user change password flow
    --old-password PWD      Old password (required for --user)

EXAMPLES:
    # Admin set permanent password (first login)
    $(basename "$0") --username user@example.com --new-password 'MyNewPass123!'

    # User change their own password
    $(basename "$0") --username user@example.com \\
      --old-password 'TempPass123!' \\
      --new-password 'MyNewPass123!' \\
      --user

    # Interactive mode (will prompt for values)
    $(basename "$0")

PASSWORD REQUIREMENTS:
    - Minimum 12 characters
    - At least one uppercase letter
    - At least one lowercase letter
    - At least one number
    - At least one symbol (!@#$%^&*)

NOTE:
    This script requires the Cognito configuration files:
      - ${OUTPUTS_DIR}/cognito-config.env

    Or you can set these environment variables:
      - COGNITO_USER_POOL_ID
      - AWS_REGION

EOF
    exit 0
}

# Default values
USERNAME=""
NEW_PASSWORD=""
OLD_PASSWORD=""
METHOD="admin"
INTERACTIVE=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -u|--username)
            USERNAME="$2"
            shift 2
            ;;
        -p|--new-password)
            NEW_PASSWORD="$2"
            shift 2
            ;;
        --old-password)
            OLD_PASSWORD="$2"
            shift 2
            ;;
        --admin)
            METHOD="admin"
            shift
            ;;
        --user)
            METHOD="user"
            shift
            ;;
        *)
            print_error "Unknown option: $1"
            echo ""
            usage
            ;;
    esac
done

print_header

# ============================================
# Load Configuration
# ============================================

ENV_FILE="${OUTPUTS_DIR}/cognito-config.env"

# Load from file if exists
if [[ -f "$ENV_FILE" ]]; then
    print_info "Loading configuration from: ${ENV_FILE}"

    # Source the env file (safely)
    export $(grep -v '^#' "$ENV_FILE" | grep -v '^$' | xargs)

    USER_POOL_ID="${COGNITO_USER_POOL_ID:-}"
    AWS_REGION="${AWS_REGION:-us-east-1}"
    AWS_PROFILE="${AWS_PROFILE:-patrickcmd}"
    DEFAULT_USERNAME="${OWNER_EMAIL:-}"
else
    print_warning "Configuration file not found: ${ENV_FILE}"
    print_info "Checking environment variables..."

    USER_POOL_ID="${COGNITO_USER_POOL_ID:-}"
    AWS_REGION="${AWS_REGION:-us-east-1}"
    AWS_PROFILE="${AWS_PROFILE:-}"
    DEFAULT_USERNAME=""
fi

# Build AWS CLI options
if [[ -n "$AWS_PROFILE" ]]; then
    AWS_OPTS="--profile $AWS_PROFILE --region $AWS_REGION"
else
    AWS_OPTS="--region $AWS_REGION"
fi

# Check required values
if [[ -z "$USER_POOL_ID" ]]; then
    print_error "COGNITO_USER_POOL_ID not found"
    print_info "Either:"
    echo "  1. Run ./aws/bin/setup-cognito first"
    echo "  2. Set COGNITO_USER_POOL_ID environment variable"
    exit 1
fi

print_success "User Pool ID: ${USER_POOL_ID}"
echo ""

# ============================================
# Interactive Mode
# ============================================

# Prompt for username if not provided
if [[ -z "$USERNAME" ]]; then
    if [[ -n "$DEFAULT_USERNAME" ]]; then
        echo -ne "${BLUE}Username [${DEFAULT_USERNAME}]: ${NC}"
        read USERNAME
        USERNAME="${USERNAME:-$DEFAULT_USERNAME}"
    else
        echo -ne "${BLUE}Username (email): ${NC}"
        read USERNAME
    fi
fi

# Validate username
if [[ -z "$USERNAME" ]]; then
    print_error "Username is required"
    exit 1
fi

print_info "Username: ${USERNAME}"
echo ""

# ============================================
# Password Validation Function
# ============================================

validate_password() {
    local password="$1"
    local errors=()

    # Check length
    if [[ ${#password} -lt 12 ]]; then
        errors+=("Password must be at least 12 characters long")
    fi

    # Check for uppercase
    if ! [[ "$password" =~ [A-Z] ]]; then
        errors+=("Password must contain at least one uppercase letter")
    fi

    # Check for lowercase
    if ! [[ "$password" =~ [a-z] ]]; then
        errors+=("Password must contain at least one lowercase letter")
    fi

    # Check for number
    if ! [[ "$password" =~ [0-9] ]]; then
        errors+=("Password must contain at least one number")
    fi

    # Check for symbol
    if ! [[ "$password" =~ [^a-zA-Z0-9] ]]; then
        errors+=("Password must contain at least one symbol")
    fi

    if [[ ${#errors[@]} -gt 0 ]]; then
        print_error "Password validation failed:"
        for error in "${errors[@]}"; do
            echo "  - $error"
        done
        return 1
    fi

    return 0
}

# ============================================
# Get Passwords
# ============================================

# For user method, need old password
if [[ "$METHOD" == "user" ]] && [[ -z "$OLD_PASSWORD" ]]; then
    echo -ne "${BLUE}Old password: ${NC}"
    read -s OLD_PASSWORD
    echo ""
fi

# Get new password if not provided
if [[ -z "$NEW_PASSWORD" ]]; then
    echo -ne "${BLUE}New password: ${NC}"
    read -s NEW_PASSWORD
    echo ""
    echo -ne "${BLUE}Confirm new password: ${NC}"
    read -s NEW_PASSWORD_CONFIRM
    echo ""

    if [[ "$NEW_PASSWORD" != "$NEW_PASSWORD_CONFIRM" ]]; then
        print_error "Passwords do not match"
        exit 1
    fi
fi

# Validate new password
if ! validate_password "$NEW_PASSWORD"; then
    exit 1
fi

echo ""

# ============================================
# Change Password
# ============================================

if [[ "$METHOD" == "admin" ]]; then
    print_info "Using admin set password method..."
    print_warning "This will set a permanent password without requiring the old password"
    echo ""

    read -p "$(echo -e ${YELLOW}Continue? [y/N]: ${NC})" -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Cancelled"
        exit 0
    fi

    echo ""
    print_info "Setting permanent password..."

    if aws cognito-idp admin-set-user-password \
        --user-pool-id "$USER_POOL_ID" \
        --username "$USERNAME" \
        --password "$NEW_PASSWORD" \
        --permanent \
        --profile $AWS_PROFILE \
        $AWS_OPTS; then

        echo ""
        print_success "Password changed successfully!"
        print_info "The user can now login with the new password"
    else
        echo ""
        print_error "Failed to change password"
        exit 1
    fi
else
    # User method (requires Cognito API credentials)
    print_error "User change password flow requires AWS Cognito Identity Provider SDK"
    print_info "For now, use admin method with --admin flag"
    print_info "Or change password through the Cognito Hosted UI"
    exit 1
fi

echo ""

# ============================================
# Next Steps
# ============================================

print_info "Next Steps:"
echo "  1. Test login with new password"
echo "  2. Update backend/.env if needed"
echo "  3. Delete temporary password from cognito-config.env"
echo ""

print_info "Test login command:"
if [[ -n "$AWS_PROFILE" ]]; then
    echo "  aws cognito-idp admin-initiate-auth \\"
    echo "    --user-pool-id ${USER_POOL_ID} \\"
    echo "    --client-id \${COGNITO_CLIENT_ID} \\"
    echo "    --auth-flow ADMIN_USER_PASSWORD_AUTH \\"
    echo "    --auth-parameters USERNAME=${USERNAME},PASSWORD='YourPassword' \\"
    echo "    --profile ${AWS_PROFILE} \\"
    echo "    --region ${AWS_REGION}"
else
    echo "  aws cognito-idp admin-initiate-auth \\"
    echo "    --user-pool-id ${USER_POOL_ID} \\"
    echo "    --client-id \${COGNITO_CLIENT_ID} \\"
    echo "    --auth-flow ADMIN_USER_PASSWORD_AUTH \\"
    echo "    --auth-parameters USERNAME=${USERNAME},PASSWORD='YourPassword' \\"
    echo "    --region ${AWS_REGION}"
fi
echo ""

#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Route 53 DNS Setup for CloudFront
# ============================================
# This script creates Route 53 A records (alias) pointing to CloudFront distribution
# for both apex domain and www subdomain

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${BLUE}â„¹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ ${1}${NC}"
}

print_error() {
    echo -e "${RED}âœ— ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘   Route 53 DNS Setup for CloudFront Distribution          â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

print_header

# Configuration
STACK_NAME="${STACK_NAME:-portfolio-frontend-stack}"
AWS_REGION="${AWS_REGION:-us-east-1}"
AWS_PROFILE="${AWS_PROFILE:-patrickcmd}"
DOMAIN_NAME="${DOMAIN_NAME:-patrickcmd.dev}"

# CloudFront hosted zone ID (constant for all CloudFront distributions)
CLOUDFRONT_HOSTED_ZONE_ID="Z2FDTNDATAQYW2"

print_info "Configuration:"
echo "  Stack Name: ${STACK_NAME}"
echo "  AWS Region: ${AWS_REGION}"
echo "  AWS Profile: ${AWS_PROFILE}"
echo "  Domain: ${DOMAIN_NAME}"
echo ""

# ============================================
# Get CloudFront Distribution Domain
# ============================================

print_info "Getting CloudFront distribution domain from stack..."

CLOUDFRONT_DOMAIN=$(aws cloudformation describe-stacks \
  --stack-name "${STACK_NAME}" \
  --region "${AWS_REGION}" \
  --profile "${AWS_PROFILE}" \
  --query 'Stacks[0].Outputs[?OutputKey==`CloudFrontDistributionDomainName`].OutputValue' \
  --output text)

if [ -z "$CLOUDFRONT_DOMAIN" ]; then
    print_error "Failed to get CloudFront distribution domain from stack outputs"
    print_info "Make sure the stack exists and has completed deployment"
    exit 1
fi

print_success "CloudFront Domain: ${CLOUDFRONT_DOMAIN}"
echo ""

# ============================================
# Get Route 53 Hosted Zone ID
# ============================================

print_info "Getting Route 53 hosted zone ID..."

HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
  --profile "${AWS_PROFILE}" \
  --query "HostedZones[?Name=='${DOMAIN_NAME}.'].Id" \
  --output text | cut -d'/' -f3)

if [ -z "$HOSTED_ZONE_ID" ]; then
    print_error "Failed to find Route 53 hosted zone for ${DOMAIN_NAME}"
    print_info "Create a hosted zone first: aws route53 create-hosted-zone --name ${DOMAIN_NAME}"
    exit 1
fi

print_success "Hosted Zone ID: ${HOSTED_ZONE_ID}"
echo ""

# ============================================
# Check Existing Records
# ============================================

print_info "Checking for existing A records..."

EXISTING_APEX=$(aws route53 list-resource-record-sets \
  --hosted-zone-id "${HOSTED_ZONE_ID}" \
  --profile "${AWS_PROFILE}" \
  --query "ResourceRecordSets[?Name=='${DOMAIN_NAME}.' && Type=='A']" \
  --output text 2>/dev/null || echo "")

EXISTING_WWW=$(aws route53 list-resource-record-sets \
  --hosted-zone-id "${HOSTED_ZONE_ID}" \
  --profile "${AWS_PROFILE}" \
  --query "ResourceRecordSets[?Name=='www.${DOMAIN_NAME}.' && Type=='A']" \
  --output text 2>/dev/null || echo "")

if [ -n "$EXISTING_APEX" ]; then
    print_warning "A record for ${DOMAIN_NAME} already exists"
    print_info "It will be updated (UPSERT)"
else
    print_info "No existing A record for ${DOMAIN_NAME}"
fi

if [ -n "$EXISTING_WWW" ]; then
    print_warning "A record for www.${DOMAIN_NAME} already exists"
    print_info "It will be updated (UPSERT)"
else
    print_info "No existing A record for www.${DOMAIN_NAME}"
fi

echo ""

# ============================================
# Create DNS Change Batch
# ============================================

print_info "Creating DNS change batch..."

cat > /tmp/dns-changes-${DOMAIN_NAME}.json <<EOF
{
  "Comment": "Create A records for CloudFront distribution",
  "Changes": [
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "${DOMAIN_NAME}",
        "Type": "A",
        "AliasTarget": {
          "HostedZoneId": "${CLOUDFRONT_HOSTED_ZONE_ID}",
          "DNSName": "${CLOUDFRONT_DOMAIN}",
          "EvaluateTargetHealth": false
        }
      }
    },
    {
      "Action": "UPSERT",
      "ResourceRecordSet": {
        "Name": "www.${DOMAIN_NAME}",
        "Type": "A",
        "AliasTarget": {
          "HostedZoneId": "${CLOUDFRONT_HOSTED_ZONE_ID}",
          "DNSName": "${CLOUDFRONT_DOMAIN}",
          "EvaluateTargetHealth": false
        }
      }
    }
  ]
}
EOF

print_success "DNS change batch created at /tmp/dns-changes-${DOMAIN_NAME}.json"
echo ""

# ============================================
# Apply DNS Changes
# ============================================

print_info "Applying DNS changes to Route 53..."

CHANGE_INFO=$(aws route53 change-resource-record-sets \
  --hosted-zone-id "${HOSTED_ZONE_ID}" \
  --profile "${AWS_PROFILE}" \
  --change-batch file:///tmp/dns-changes-${DOMAIN_NAME}.json \
  --output json)

CHANGE_ID=$(echo "$CHANGE_INFO" | grep -o '"Id": "[^"]*"' | cut -d'"' -f4)

print_success "DNS changes submitted successfully!"
print_info "Change ID: ${CHANGE_ID}"
echo ""

# ============================================
# Wait for DNS Propagation
# ============================================

print_info "Waiting for DNS changes to propagate..."
print_warning "This usually takes 1-5 minutes for Route 53"
echo ""

RETRY_COUNT=0
MAX_RETRIES=30

while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
    STATUS=$(aws route53 get-change \
      --id "${CHANGE_ID}" \
      --profile "${AWS_PROFILE}" \
      --query 'ChangeInfo.Status' \
      --output text)

    if [ "$STATUS" = "INSYNC" ]; then
        print_success "DNS changes have propagated!"
        break
    fi

    echo -n "."
    sleep 10
    RETRY_COUNT=$((RETRY_COUNT + 1))
done

echo ""

if [ "$STATUS" != "INSYNC" ]; then
    print_warning "DNS propagation is taking longer than expected"
    print_info "Changes are still in progress, check manually with:"
    echo "  aws route53 get-change --id ${CHANGE_ID} --profile ${AWS_PROFILE}"
else
    echo ""
    print_success "Route 53 DNS setup complete!"
fi

echo ""

# ============================================
# Verify DNS Records
# ============================================

print_info "Verifying DNS records..."
echo ""

print_info "Route 53 records:"
aws route53 list-resource-record-sets \
  --hosted-zone-id "${HOSTED_ZONE_ID}" \
  --profile "${AWS_PROFILE}" \
  --query "ResourceRecordSets[?Type=='A' && (Name=='${DOMAIN_NAME}.' || Name=='www.${DOMAIN_NAME}.')].[Name,Type,AliasTarget.DNSName]" \
  --output table

echo ""

# ============================================
# Test DNS Resolution
# ============================================

print_info "Testing DNS resolution (may take a few minutes to propagate globally)..."
echo ""

print_info "Apex domain (${DOMAIN_NAME}):"
dig ${DOMAIN_NAME} +short | head -5 || echo "  Not yet resolved"
echo ""

print_info "WWW subdomain (www.${DOMAIN_NAME}):"
dig www.${DOMAIN_NAME} +short | head -5 || echo "  Not yet resolved"
echo ""

# ============================================
# Summary and Next Steps
# ============================================

print_success "DNS Configuration Complete!"
echo ""

print_info "Next steps:"
echo "  1. Wait 1-5 minutes for global DNS propagation"
echo "  2. Test apex domain: curl -I https://${DOMAIN_NAME}"
echo "  3. Test www redirect: curl -I https://www.${DOMAIN_NAME}"
echo "  4. Open in browser: https://${DOMAIN_NAME}"
echo ""

print_info "Verify DNS propagation:"
echo "  dig ${DOMAIN_NAME}"
echo "  dig www.${DOMAIN_NAME}"
echo ""

print_info "Check DNS globally:"
echo "  https://www.whatsmydns.net/#A/${DOMAIN_NAME}"
echo ""

print_success "Your website should now be accessible at:"
echo "  â€¢ https://${DOMAIN_NAME}"
echo "  â€¢ https://www.${DOMAIN_NAME} (redirects to apex)"
echo ""

# Clean up
rm -f /tmp/dns-changes-${DOMAIN_NAME}.json

print_success "Setup complete! ðŸš€"

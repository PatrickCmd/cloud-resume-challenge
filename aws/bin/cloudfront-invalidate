#!/usr/bin/env bash
set -euo pipefail

# ============================================
# CloudFront Cache Invalidation Script
# ============================================
# This script creates an invalidation for CloudFront distribution
# to clear cached content and serve fresh files

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
PLAYBOOKS_DIR="${PROJECT_ROOT}/playbooks"

# Default values
VAULT_PASSWORD_FILE="${VAULT_PASSWORD_FILE:-$HOME/.vault_pass.txt}"
VERBOSITY=""
INVALIDATION_TYPE="all"
CUSTOM_PATHS=""

# Function to print colored messages
print_info() {
    echo -e "${BLUE}â„¹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ ${1}${NC}"
}

print_error() {
    echo -e "${RED}âœ— ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš  ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘        CloudFront Cache Invalidation Script               â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

CloudFront cache invalidation script for frontend updates.

OPTIONS:
    -h, --help              Show this help message
    -v, --verbose           Verbose output (-v, -vv, -vvv for more verbosity)
    --all                   Invalidate all paths (/* - default)
    --html                  Invalidate only HTML files
    --paths PATHS           Invalidate specific paths (comma-separated)
    --vault-password-file   Path to vault password file
                           (default: ~/.vault_pass.txt)

EXAMPLES:
    # Invalidate everything (default)
    $(basename "$0")

    # Invalidate only HTML files (faster, cheaper)
    $(basename "$0") --html

    # Invalidate specific paths
    $(basename "$0") --paths "/index.html,/assets/main.js,/images/*"

    # Verbose mode
    $(basename "$0") --verbose

INVALIDATION TYPES:
    all     - Invalidates all cached content (/*)
              Use after major updates or deployments

    html    - Invalidates only HTML files (/index.html, /*.html)
              Use for SPA content updates (recommended)

    custom  - Invalidates specific paths you specify
              Use when you know exactly what changed

COST INFORMATION:
    â€¢ First 1,000 invalidation paths per month: FREE
    â€¢ After that: \$0.005 per path
    â€¢ Using wildcards (/*) counts as 1 path
    â€¢ Specific files (/file1, /file2) count individually

NOTES:
    â€¢ Invalidation typically completes in 1-5 minutes
    â€¢ You can continue working while invalidation processes
    â€¢ Check status with: aws cloudfront list-invalidations
    â€¢ Alternative: Use versioned file names (Vite does this automatically)

For more information, see:
    aws/CLOUDFRONT-SETUP.md#cache-invalidation

EOF
    exit 0
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -v|--verbose)
            if [[ "$VERBOSITY" == "" ]]; then
                VERBOSITY="-v"
            elif [[ "$VERBOSITY" == "-v" ]]; then
                VERBOSITY="-vv"
            else
                VERBOSITY="-vvv"
            fi
            shift
            ;;
        -vv)
            VERBOSITY="-vv"
            shift
            ;;
        -vvv)
            VERBOSITY="-vvv"
            shift
            ;;
        --all)
            INVALIDATION_TYPE="all"
            shift
            ;;
        --html)
            INVALIDATION_TYPE="html"
            shift
            ;;
        --paths)
            INVALIDATION_TYPE="custom"
            CUSTOM_PATHS="$2"
            shift 2
            ;;
        --vault-password-file)
            VAULT_PASSWORD_FILE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            echo ""
            usage
            ;;
    esac
done

print_header

# ============================================
# Prerequisites Check
# ============================================

print_info "Checking prerequisites..."
echo ""

# Check if ansible is installed
if ! command -v ansible-playbook &> /dev/null; then
    print_error "Ansible is not installed"
    print_info "Install with: pip install ansible"
    exit 1
fi
print_success "Ansible found"

# Check if vault password file exists
if [[ ! -f "$VAULT_PASSWORD_FILE" ]]; then
    print_error "Vault password file not found: $VAULT_PASSWORD_FILE"
    print_info "Create it with: echo 'your-password' > ~/.vault_pass.txt && chmod 600 ~/.vault_pass.txt"
    exit 1
fi
print_success "Vault password file found"

# Check if playbook exists
PLAYBOOK_FILE="${PLAYBOOKS_DIR}/cloudfront-invalidate.yml"
if [[ ! -f "$PLAYBOOK_FILE" ]]; then
    print_error "Playbook not found: $PLAYBOOK_FILE"
    exit 1
fi
print_success "Playbook found"

echo ""

# ============================================
# Display Configuration
# ============================================

print_info "Invalidation Configuration:"
echo "  Type: ${INVALIDATION_TYPE}"
if [[ "$INVALIDATION_TYPE" == "custom" ]]; then
    echo "  Paths: ${CUSTOM_PATHS}"
elif [[ "$INVALIDATION_TYPE" == "html" ]]; then
    echo "  Paths: /index.html, /*.html"
else
    echo "  Paths: /* (all)"
fi
echo ""

# Confirm if invalidating all paths
if [[ "$INVALIDATION_TYPE" == "all" ]]; then
    print_warning "You are about to invalidate ALL cached content"
    print_info "This will clear the entire CloudFront cache"
    print_info "Consider using --html for faster, more targeted invalidation"
    echo ""
fi

# ============================================
# Run Invalidation
# ============================================

print_info "Creating CloudFront invalidation..."
echo ""

# Build ansible command
ANSIBLE_CMD="ansible-playbook"
ANSIBLE_CMD="$ANSIBLE_CMD $PLAYBOOK_FILE"
ANSIBLE_CMD="$ANSIBLE_CMD --vault-password-file=$VAULT_PASSWORD_FILE"

# Add verbosity
if [[ "$VERBOSITY" != "" ]]; then
    ANSIBLE_CMD="$ANSIBLE_CMD $VERBOSITY"
fi

# Add tags or extra vars based on invalidation type
case $INVALIDATION_TYPE in
    all)
        ANSIBLE_CMD="$ANSIBLE_CMD --tags all"
        ;;
    html)
        ANSIBLE_CMD="$ANSIBLE_CMD --tags html"
        ;;
    custom)
        ANSIBLE_CMD="$ANSIBLE_CMD --tags custom --extra-vars paths='$CUSTOM_PATHS'"
        ;;
esac

# Change to playbooks directory
cd "$PLAYBOOKS_DIR"

# Run the playbook
if eval "$ANSIBLE_CMD"; then
    echo ""
    print_success "Invalidation created successfully!"
    echo ""

    print_info "What happens next:"
    echo "  1. CloudFront processes the invalidation (1-5 minutes)"
    echo "  2. Cached content is marked as stale"
    echo "  3. Next request fetches fresh content from S3"
    echo ""

    print_info "Verify cache is cleared:"
    echo "  curl -I https://patrickcmd.dev"
    echo "  # Look for 'x-cache: Miss from cloudfront'"
    echo ""

    print_info "Check invalidation status:"
    echo "  aws cloudfront list-invalidations \\"
    echo "    --distribution-id YOUR_DIST_ID \\"
    echo "    --profile patrickcmd"
    echo ""
else
    echo ""
    print_error "Invalidation failed"
    print_info "Check the error messages above"
    print_info "Common issues:"
    echo "  â€¢ Vault password incorrect"
    echo "  â€¢ AWS credentials not configured"
    echo "  â€¢ CloudFormation stack not found"
    echo ""
    exit 1
fi

print_success "Done! ğŸš€"

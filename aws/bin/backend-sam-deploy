#!/usr/bin/env bash
# Backend SAM Deployment Script for Cloud Resume Challenge
# Wrapper script for Ansible playbook deployment using AWS SAM
#
# Usage:
#   ./bin/backend-sam-deploy              # Deploy with default settings
#   ./bin/backend-sam-deploy --help       # Show help
#   ./bin/backend-sam-deploy --validate   # Only validate SAM template
#   ./bin/backend-sam-deploy --verbose    # Run with verbose output

set -euo pipefail  # Exit on error, undefined variables, and pipe failures

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Script directory
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly AWS_DIR="$(dirname "$SCRIPT_DIR")"
readonly PLAYBOOKS_DIR="$AWS_DIR/playbooks"
readonly PLAYBOOK="$PLAYBOOKS_DIR/backend-sam-deploy.yml"

# Default values
VERBOSE=""
TAGS=""
CHECK_MODE=""
EXTRA_VARS=""

# Functions
print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

show_help() {
    cat << HELP
Backend SAM Deployment Script - Cloud Resume Challenge

Usage:
    $(basename "$0") [OPTIONS]

Options:
    -h, --help              Show this help message
    -v, --verbose           Run with verbose output (-vv for more verbose)
    -vvv                    Run with debug output
    --validate              Only validate SAM template (don't deploy)
    --build                 Only build SAM application
    --deploy                Only deploy stack (skip build and validate)
    --info                  Only show stack information
    --check                 Dry run - show what would be deployed
    --env ENV               Override environment (development/staging/production)
    --profile PROFILE       Override AWS profile
    --domain NAME           Override custom domain name

Examples:
    # Deploy with default settings
    $(basename "$0")

    # Deploy with verbose output
    $(basename "$0") --verbose

    # Only validate SAM template
    $(basename "$0") --validate

    # Only build SAM application
    $(basename "$0") --build

    # Deploy to different environment
    $(basename "$0") --env staging --domain api-staging.patrickcmd.dev

    # Dry run
    $(basename "$0") --check

Prerequisites:
    - Ansible installed
    - AWS SAM CLI installed
    - AWS CLI configured
    - Python 3.12+ and uv installed
    - Vault password file at ~/.vault_pass.txt
    - Encrypted vault at playbooks/vaults/config.yml
    - ACM certificate for custom domain (in us-east-1)

SAM Template:
    Location: aws/backend.yaml
    Deploys:
      - DynamoDB Table (single-table design)
      - Lambda Function (FastAPI with Mangum)
      - API Gateway REST API
      - Custom Domain (api.patrickcmd.dev)
      - CloudWatch Logs
      - IAM Roles

For more information, see:
    - backend/README.md
    - backend/docs/LOCAL_TESTING.md
    - backend/docs/DYNAMODB-DESIGN.md

HELP
}

check_prerequisites() {
    print_info "Checking prerequisites..."

    # Check if Ansible is installed
    if ! command -v ansible-playbook &> /dev/null; then
        print_error "Ansible is not installed"
        print_info "Install with: pip install ansible"
        exit 1
    fi

    # Check if SAM CLI is installed
    if ! command -v sam &> /dev/null; then
        print_error "AWS SAM CLI is not installed"
        print_info "Install with: brew install aws-sam-cli (macOS)"
        print_info "Or see: https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html"
        exit 1
    fi

    # Check if playbook exists
    if [[ ! -f "$PLAYBOOK" ]]; then
        print_error "Playbook not found: $PLAYBOOK"
        exit 1
    fi

    # Check if vault password file exists
    if [[ ! -f "$HOME/.vault_pass.txt" ]]; then
        print_warning "Vault password file not found at ~/.vault_pass.txt"
        print_info "You will be prompted for the vault password"
    fi

    # Check if AWS CLI is installed
    if ! command -v aws &> /dev/null; then
        print_error "AWS CLI is not installed"
        print_info "Install with: pip install awscli"
        exit 1
    fi

    # Check if uv is installed
    if ! command -v uv &> /dev/null; then
        print_warning "uv is not installed (optional but recommended for faster builds)"
        print_info "Install with: curl -LsSf https://astral.sh/uv/install.sh | sh"
    fi

    print_success "Prerequisites check passed"
}

parse_arguments() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--verbose)
                VERBOSE="-v"
                shift
                ;;
            -vv)
                VERBOSE="-vv"
                shift
                ;;
            -vvv)
                VERBOSE="-vvv"
                shift
                ;;
            --validate)
                TAGS="--tags validate"
                shift
                ;;
            --build)
                TAGS="--tags build"
                shift
                ;;
            --deploy)
                TAGS="--tags deploy"
                shift
                ;;
            --info)
                TAGS="--tags info"
                shift
                ;;
            --check)
                CHECK_MODE="--check"
                shift
                ;;
            --env)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e backend_config.environment=$2"
                    shift 2
                else
                    print_error "Error: --env requires a value"
                    exit 1
                fi
                ;;
            --profile)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e aws_config.profile=$2"
                    shift 2
                else
                    print_error "Error: --profile requires a value"
                    exit 1
                fi
                ;;
            --domain)
                if [[ -n "${2:-}" ]]; then
                    EXTRA_VARS="$EXTRA_VARS -e backend_config.custom_domain_name=$2"
                    shift 2
                else
                    print_error "Error: --domain requires a value"
                    exit 1
                fi
                ;;
            *)
                print_error "Unknown option: $1"
                echo ""
                show_help
                exit 1
                ;;
        esac
    done
}

run_deployment() {
    print_info "Starting backend deployment..."
    echo ""

    # Change to playbooks directory
    cd "$PLAYBOOKS_DIR"

    # Build ansible-playbook command
    local cmd="ansible-playbook backend-sam-deploy.yml"

    # Add verbose flag if set
    if [[ -n "$VERBOSE" ]]; then
        cmd="$cmd $VERBOSE"
    fi

    # Add tags if set
    if [[ -n "$TAGS" ]]; then
        cmd="$cmd $TAGS"
    fi

    # Add check mode if set
    if [[ -n "$CHECK_MODE" ]]; then
        cmd="$cmd $CHECK_MODE"
    fi

    # Add extra vars if set
    if [[ -n "$EXTRA_VARS" ]]; then
        cmd="$cmd $EXTRA_VARS"
    fi

    print_info "Running: $cmd"
    echo ""

    # Run the ansible-playbook command
    if eval "$cmd"; then
        echo ""
        print_success "Backend deployment completed successfully!"

        # Show outputs file location if deployment succeeded
        if [[ -z "$TAGS" ]] || [[ "$TAGS" == *"info"* ]] || [[ "$TAGS" == *"deploy"* ]]; then
            echo ""
            print_info "Stack outputs saved to: $AWS_DIR/outputs/backend-stack-outputs.env"
            echo ""
            print_info "Next steps:"
            print_info "  1. Test health endpoint: curl https://api.patrickcmd.dev/health"
            print_info "  2. View API docs (if development): https://api.patrickcmd.dev/docs"
            print_info "  3. Monitor Lambda logs: aws logs tail /aws/lambda/production-portfolio-api --follow"
            print_info "  4. Test authentication with Cognito"
        fi

        return 0
    else
        echo ""
        print_error "Backend deployment failed!"
        echo ""
        print_info "Troubleshooting tips:"
        print_info ""
        print_info "1. Check SAM build errors:"
        print_info "   cd aws && sam build --template backend.yaml"
        print_info ""
        print_info "2. Validate SAM template:"
        print_info "   sam validate --template aws/backend.yaml"
        print_info ""
        print_info "3. Check CloudFormation stack:"
        print_info "   aws cloudformation describe-stack-events --stack-name production-portfolio-backend-api"
        print_info ""
        print_info "4. View Lambda logs:"
        print_info "   aws logs tail /aws/lambda/production-portfolio-api --follow"
        print_info ""
        print_info "5. Check DynamoDB table:"
        print_info "   aws dynamodb describe-table --table-name production-portfolio-api-table"
        print_info ""
        print_info "6. Delete failed stack:"
        print_info "   sam delete --stack-name production-portfolio-backend-api"
        print_info ""
        print_info "7. Review playbook logs above for error details"
        echo ""
        return 1
    fi
}

main() {
    # Parse command line arguments
    parse_arguments "$@"

    # Show banner
    echo ""
    echo "═══════════════════════════════════════════════════════════════════"
    echo "║   Cloud Resume Challenge - Backend SAM Deployment             ║"
    echo "═══════════════════════════════════════════════════════════════════"
    echo ""

    # Check prerequisites
    check_prerequisites
    echo ""

    # Run deployment
    if run_deployment; then
        exit 0
    else
        exit 1
    fi
}

# Run main function
main "$@"

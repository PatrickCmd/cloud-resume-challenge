#!/usr/bin/env bash
set -euo pipefail

# ============================================
# AWS Budget Setup Script
# ============================================
# Creates and manages AWS monthly budgets with email notifications
# for cost monitoring and alerting

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${BLUE}ℹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
    echo -e "${RED}✗ ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${1}${NC}"
}

# Function to print header
print_header() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║           AWS Budget Setup & Management                   ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
}

# Function to show usage
show_usage() {
    cat << EOF
Usage: $0 [OPTIONS]

Options:
    -h, --help              Show this help message
    -c, --create            Create a new budget
    -u, --update            Update existing budget
    -d, --delete            Delete budget
    -s, --status            Show budget status
    -l, --list              List all budgets

Budget Configuration:
    --amount AMOUNT         Budget amount (default: 20)
    --threshold PERCENT     Alert threshold percentage (default: 80)
    --email EMAIL           Email for notifications (default: pwalukagga@gmail.com)
    --name NAME             Budget name (default: cloud-resume-challenge-budget)
    --profile PROFILE       AWS profile to use (default: patrickcmd)

Examples:
    # Create budget with defaults
    $0 --create

    # Create budget with custom amount
    $0 --create --amount 50 --threshold 90

    # Update existing budget
    $0 --update --amount 30

    # Check budget status
    $0 --status

    # Delete budget
    $0 --delete

EOF
}

print_header

# Default configuration
BUDGET_NAME="${BUDGET_NAME:-cloud-resume-challenge-budget}"
BUDGET_AMOUNT="${BUDGET_AMOUNT:-20}"
THRESHOLD_PERCENT="${THRESHOLD_PERCENT:-80}"
EMAIL_ADDRESS="${EMAIL_ADDRESS:-pwalukagga@gmail.com}"
AWS_PROFILE="${AWS_PROFILE:-patrickcmd}"
ACTION="status"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            exit 0
            ;;
        -c|--create)
            ACTION="create"
            shift
            ;;
        -u|--update)
            ACTION="update"
            shift
            ;;
        -d|--delete)
            ACTION="delete"
            shift
            ;;
        -s|--status)
            ACTION="status"
            shift
            ;;
        -l|--list)
            ACTION="list"
            shift
            ;;
        --amount)
            BUDGET_AMOUNT="$2"
            shift 2
            ;;
        --threshold)
            THRESHOLD_PERCENT="$2"
            shift 2
            ;;
        --email)
            EMAIL_ADDRESS="$2"
            shift 2
            ;;
        --name)
            BUDGET_NAME="$2"
            shift 2
            ;;
        --profile)
            AWS_PROFILE="$2"
            shift 2
            ;;
        *)
            print_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
    esac
done

# ============================================
# Validate Prerequisites
# ============================================

print_info "Checking prerequisites..."

# Check if AWS CLI is installed
if ! command -v aws &> /dev/null; then
    print_error "AWS CLI not found. Please install it first."
    exit 1
fi
print_success "AWS CLI found"

# Check if AWS profile exists
if ! aws configure list-profiles | grep -q "^${AWS_PROFILE}$"; then
    print_error "AWS profile '${AWS_PROFILE}' not found"
    print_info "Available profiles:"
    aws configure list-profiles
    exit 1
fi
print_success "AWS profile '${AWS_PROFILE}' found"

# Get AWS Account ID
ACCOUNT_ID=$(aws sts get-caller-identity \
    --profile "${AWS_PROFILE}" \
    --query 'Account' \
    --output text 2>/dev/null)

if [ -z "$ACCOUNT_ID" ]; then
    print_error "Failed to get AWS Account ID. Check your credentials."
    exit 1
fi
print_success "AWS Account ID: ${ACCOUNT_ID}"

echo ""
print_info "Budget Configuration:"
echo "  Name: ${BUDGET_NAME}"
echo "  Amount: \$${BUDGET_AMOUNT}/month"
echo "  Threshold: ${THRESHOLD_PERCENT}%"
echo "  Email: ${EMAIL_ADDRESS}"
echo "  Profile: ${AWS_PROFILE}"
echo ""

# ============================================
# Helper Functions
# ============================================

check_budget_exists() {
    aws budgets describe-budget \
        --account-id "${ACCOUNT_ID}" \
        --budget-name "${BUDGET_NAME}" \
        --profile "${AWS_PROFILE}" \
        --output json &> /dev/null
    return $?
}

# ============================================
# List Budgets
# ============================================

if [ "$ACTION" = "list" ]; then
    print_info "Listing all budgets..."
    echo ""

    aws budgets describe-budgets \
        --account-id "${ACCOUNT_ID}" \
        --profile "${AWS_PROFILE}" \
        --query 'Budgets[].[BudgetName,BudgetLimit.Amount,BudgetLimit.Unit,TimeUnit]' \
        --output table

    exit 0
fi

# ============================================
# Show Budget Status
# ============================================

if [ "$ACTION" = "status" ]; then
    print_info "Checking budget status..."
    echo ""

    if ! check_budget_exists; then
        print_warning "Budget '${BUDGET_NAME}' does not exist"
        print_info "Run '$0 --create' to create it"
        exit 0
    fi

    # Get budget details
    aws budgets describe-budget \
        --account-id "${ACCOUNT_ID}" \
        --budget-name "${BUDGET_NAME}" \
        --profile "${AWS_PROFILE}" \
        --output json | \
        python3 -c "
import json
import sys

data = json.load(sys.stdin)
budget = data['Budget']

print('Budget Details:')
print(f\"  Name: {budget['BudgetName']}\")
print(f\"  Amount: \${budget['BudgetLimit']['Amount']} {budget['BudgetLimit']['Unit']}\")
print(f\"  Time Period: {budget['TimeUnit']}\")
print(f\"  Type: {budget['BudgetType']}\")

if 'CalculatedSpend' in budget:
    actual = float(budget['CalculatedSpend']['ActualSpend']['Amount'])
    limit = float(budget['BudgetLimit']['Amount'])
    percent = (actual / limit) * 100 if limit > 0 else 0
    print(f\"  Current Spend: \${actual:.2f} ({percent:.1f}%)\")

    if 'ForecastedSpend' in budget['CalculatedSpend']:
        forecast = float(budget['CalculatedSpend']['ForecastedSpend']['Amount'])
        forecast_percent = (forecast / limit) * 100 if limit > 0 else 0
        print(f\"  Forecasted Spend: \${forecast:.2f} ({forecast_percent:.1f}%)\")
"

    echo ""
    print_info "Checking notifications..."

    # Get notifications for this budget
    aws budgets describe-notifications-for-budget \
        --account-id "${ACCOUNT_ID}" \
        --budget-name "${BUDGET_NAME}" \
        --profile "${AWS_PROFILE}" \
        --query 'Notifications[].[ComparisonOperator,Threshold,ThresholdType,NotificationType]' \
        --output table 2>/dev/null || print_warning "No notifications configured"

    exit 0
fi

# ============================================
# Delete Budget
# ============================================

if [ "$ACTION" = "delete" ]; then
    print_info "Deleting budget '${BUDGET_NAME}'..."

    if ! check_budget_exists; then
        print_warning "Budget '${BUDGET_NAME}' does not exist"
        exit 0
    fi

    # Confirm deletion
    read -p "Are you sure you want to delete this budget? (yes/no): " CONFIRM
    if [ "$CONFIRM" != "yes" ]; then
        print_info "Deletion cancelled"
        exit 0
    fi

    aws budgets delete-budget \
        --account-id "${ACCOUNT_ID}" \
        --budget-name "${BUDGET_NAME}" \
        --profile "${AWS_PROFILE}"

    print_success "Budget deleted successfully"
    exit 0
fi

# ============================================
# Create or Update Budget
# ============================================

if [ "$ACTION" = "create" ] || [ "$ACTION" = "update" ]; then

    # Check if budget exists
    BUDGET_EXISTS=false
    if check_budget_exists; then
        BUDGET_EXISTS=true
    fi

    if [ "$ACTION" = "create" ] && [ "$BUDGET_EXISTS" = true ]; then
        print_warning "Budget '${BUDGET_NAME}' already exists"
        print_info "Use --update to modify it, or --delete to remove it first"
        exit 1
    fi

    if [ "$ACTION" = "update" ] && [ "$BUDGET_EXISTS" = false ]; then
        print_warning "Budget '${BUDGET_NAME}' does not exist"
        print_info "Use --create to create it first"
        exit 1
    fi

    # Calculate threshold amount
    THRESHOLD_AMOUNT=$(echo "scale=2; $BUDGET_AMOUNT * $THRESHOLD_PERCENT / 100" | bc)

    print_info "$([ "$ACTION" = "create" ] && echo "Creating" || echo "Updating") budget..."

    # Create budget JSON
    BUDGET_JSON=$(cat <<EOF
{
  "BudgetName": "${BUDGET_NAME}",
  "BudgetLimit": {
    "Amount": "${BUDGET_AMOUNT}",
    "Unit": "USD"
  },
  "TimeUnit": "MONTHLY",
  "BudgetType": "COST",
  "CostFilters": {},
  "CostTypes": {
    "IncludeTax": true,
    "IncludeSubscription": true,
    "UseBlended": false,
    "IncludeRefund": false,
    "IncludeCredit": false,
    "IncludeUpfront": true,
    "IncludeRecurring": true,
    "IncludeOtherSubscription": true,
    "IncludeSupport": true,
    "IncludeDiscount": true,
    "UseAmortized": false
  }
}
EOF
)

    # Create or update budget
    echo "${BUDGET_JSON}" > /tmp/budget-${BUDGET_NAME}.json

    aws budgets $([ "$ACTION" = "create" ] && echo "create-budget" || echo "update-budget") \
        --account-id "${ACCOUNT_ID}" \
        --budget file:///tmp/budget-${BUDGET_NAME}.json \
        --profile "${AWS_PROFILE}"

    print_success "Budget $([ "$ACTION" = "create" ] && echo "created" || echo "updated") successfully"

    # Add or update notification
    if [ "$ACTION" = "create" ]; then
        print_info "Setting up email notification..."

        # Create separate JSON files for notification and subscribers
        NOTIFICATION_ONLY=$(cat <<EOF
{
  "NotificationType": "ACTUAL",
  "ComparisonOperator": "GREATER_THAN",
  "Threshold": ${THRESHOLD_PERCENT},
  "ThresholdType": "PERCENTAGE",
  "NotificationState": "ALARM"
}
EOF
)

        SUBSCRIBERS_ONLY=$(cat <<EOF
[
  {
    "SubscriptionType": "EMAIL",
    "Address": "${EMAIL_ADDRESS}"
  }
]
EOF
)

        echo "${NOTIFICATION_ONLY}" > /tmp/notification-only-${BUDGET_NAME}.json
        echo "${SUBSCRIBERS_ONLY}" > /tmp/subscribers-${BUDGET_NAME}.json

        if aws budgets create-notification \
            --account-id "${ACCOUNT_ID}" \
            --budget-name "${BUDGET_NAME}" \
            --notification file:///tmp/notification-only-${BUDGET_NAME}.json \
            --subscribers file:///tmp/subscribers-${BUDGET_NAME}.json \
            --profile "${AWS_PROFILE}" 2>/dev/null; then
            print_success "Notification configured successfully"
            print_warning "You must confirm the subscription email sent to ${EMAIL_ADDRESS}"
        else
            print_error "Failed to create notification"
            print_info "Check if notification already exists or verify permissions"
        fi

        # Cleanup notification temp files
        rm -f /tmp/notification-only-${BUDGET_NAME}.json /tmp/subscribers-${BUDGET_NAME}.json
    fi

    # Cleanup temp files
    rm -f /tmp/budget-${BUDGET_NAME}.json /tmp/notification-${BUDGET_NAME}.json

    echo ""
    print_success "Setup complete!"
    echo ""
    print_info "Next steps:"
    echo "  1. Check your email (${EMAIL_ADDRESS}) for AWS Notification subscription confirmation"
    echo "  2. Click the confirmation link in the email"
    echo "  3. Run '$0 --status' to view budget status"
    echo ""
    print_info "You will receive an email alert when:"
    echo "  • Your spend reaches ${THRESHOLD_PERCENT}% (\$${THRESHOLD_AMOUNT}) of \$${BUDGET_AMOUNT}"
    echo ""

    exit 0
fi

# If no action specified, show status
print_warning "No action specified. Showing budget status..."
echo ""
exec "$0" --status

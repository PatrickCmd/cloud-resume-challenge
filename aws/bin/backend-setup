#!/usr/bin/env bash
# Backend Setup Script - Cloud Resume Challenge
# Initial setup for backend API deployment including:
#   - SAM S3 bucket creation
#   - ACM certificate request and validation
#   - Cognito configuration lookup
#   - Route53 hosted zone lookup
#   - Vault configuration generation
#
# Usage:
#   ./bin/backend-setup              # Interactive setup
#   ./bin/backend-setup --help       # Show help

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# Script directory
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly AWS_DIR="$(dirname "$SCRIPT_DIR")"
readonly PLAYBOOKS_DIR="$AWS_DIR/playbooks"

# Default values
AWS_REGION="us-east-1"
AWS_PROFILE="${AWS_PROFILE:-patrickcmd}"
DOMAIN_NAME="patrickcmd.dev"
API_SUBDOMAIN="api"
API_DOMAIN="${API_SUBDOMAIN}.${DOMAIN_NAME}"
SAM_BUCKET_NAME=""
ENVIRONMENT="production"

# Functions
print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_step() {
    echo ""
    echo -e "${CYAN}▶${NC} ${1}"
    echo "────────────────────────────────────────────────────────────────"
}

show_help() {
    cat << 'HELP'
Backend Setup Script - Cloud Resume Challenge

This script sets up the prerequisites for backend API deployment:
  1. Creates SAM deployment S3 bucket
  2. Requests ACM certificate for api.patrickcmd.dev
  3. Helps validate ACM certificate via DNS
  4. Looks up Cognito configuration
  5. Finds Route53 hosted zone
  6. Generates vault configuration

Usage:
    ./bin/backend-setup [OPTIONS]

Options:
    -h, --help              Show this help message
    --region REGION         AWS region (default: us-east-1)
    --profile PROFILE       AWS profile (default: patrickcmd)
    --domain DOMAIN         Base domain (default: patrickcmd.dev)
    --api-subdomain SUB     API subdomain (default: api)
    --env ENV               Environment (default: production)
    --bucket NAME           SAM S3 bucket name (auto-generated if not provided)
    --skip-bucket           Skip S3 bucket creation
    --skip-certificate      Skip ACM certificate request
    --skip-validation       Skip certificate validation check

Examples:
    # Interactive setup with defaults
    ./bin/backend-setup

    # Setup with custom domain
    ./bin/backend-setup --domain mysite.com --api-subdomain backend

    # Setup for staging environment
    ./bin/backend-setup --env staging --api-subdomain api-staging

    # Skip bucket creation (already exists)
    ./bin/backend-setup --skip-bucket

Prerequisites:
    - AWS CLI configured with valid credentials
    - Route53 hosted zone for your domain
    - Cognito User Pool already created (via setup-cognito)

HELP
}

check_prerequisites() {
    print_step "Checking Prerequisites"

    # Check AWS CLI
    if ! command -v aws &> /dev/null; then
        print_error "AWS CLI is not installed"
        exit 1
    fi
    print_success "AWS CLI installed"

    # Check AWS credentials
    if ! aws sts get-caller-identity --profile "$AWS_PROFILE" &> /dev/null; then
        print_error "AWS credentials not configured for profile: $AWS_PROFILE"
        print_info "Run: aws configure --profile $AWS_PROFILE"
        exit 1
    fi
    print_success "AWS credentials configured"

    # Get account ID
    ACCOUNT_ID=$(aws sts get-caller-identity --profile "$AWS_PROFILE" --query 'Account' --output text)
    print_info "AWS Account ID: $ACCOUNT_ID"
}

create_sam_bucket() {
    print_step "Setting Up SAM Deployment Bucket"

    # Generate bucket name if not provided
    if [[ -z "$SAM_BUCKET_NAME" ]]; then
        SAM_BUCKET_NAME="${DOMAIN_NAME//./-}-sam-deployments"
    fi

    print_info "Bucket name: $SAM_BUCKET_NAME"

    # Check if bucket exists
    if aws s3 ls "s3://$SAM_BUCKET_NAME" --profile "$AWS_PROFILE" &> /dev/null; then
        print_warning "Bucket already exists: $SAM_BUCKET_NAME"
        read -p "Use existing bucket? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_error "Aborted by user"
            exit 1
        fi
    else
        # Create bucket
        print_info "Creating S3 bucket..."
        if aws s3 mb "s3://$SAM_BUCKET_NAME" --region "$AWS_REGION" --profile "$AWS_PROFILE"; then
            print_success "Bucket created: $SAM_BUCKET_NAME"
        else
            print_error "Failed to create bucket"
            exit 1
        fi

        # Enable versioning
        print_info "Enabling versioning..."
        if aws s3api put-bucket-versioning \
            --bucket "$SAM_BUCKET_NAME" \
            --versioning-configuration Status=Enabled \
            --profile "$AWS_PROFILE"; then
            print_success "Versioning enabled"
        else
            print_warning "Failed to enable versioning (non-fatal)"
        fi

        # Add lifecycle policy
        print_info "Adding lifecycle policy (delete old versions after 30 days)..."
        cat > /tmp/sam-bucket-lifecycle.json << 'EOF'
{
  "Rules": [
    {
      "Id": "DeleteOldVersions",
      "Status": "Enabled",
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 30
      }
    }
  ]
}
EOF

        if aws s3api put-bucket-lifecycle-configuration \
            --bucket "$SAM_BUCKET_NAME" \
            --lifecycle-configuration file:///tmp/sam-bucket-lifecycle.json \
            --profile "$AWS_PROFILE"; then
            print_success "Lifecycle policy added"
        else
            print_warning "Failed to add lifecycle policy (non-fatal)"
        fi

        rm -f /tmp/sam-bucket-lifecycle.json
    fi

    print_success "SAM bucket ready: s3://$SAM_BUCKET_NAME"
}

get_hosted_zone() {
    print_step "Looking Up Route53 Hosted Zone"

    print_info "Searching for hosted zone: $DOMAIN_NAME"

    HOSTED_ZONE_ID=$(aws route53 list-hosted-zones \
        --profile "$AWS_PROFILE" \
        --query "HostedZones[?Name=='${DOMAIN_NAME}.'].Id" \
        --output text | sed 's|/hostedzone/||')

    if [[ -z "$HOSTED_ZONE_ID" ]]; then
        print_error "Hosted zone not found for: $DOMAIN_NAME"
        print_info "Create a hosted zone first:"
        print_info "  aws route53 create-hosted-zone --name $DOMAIN_NAME --caller-reference $(date +%s)"
        exit 1
    fi

    print_success "Hosted zone found: $HOSTED_ZONE_ID"
}

find_certificate() {
    print_step "Finding ACM Certificate"

    print_info "Looking for certificate covering: $API_DOMAIN"
    print_info "Region: $AWS_REGION (must be us-east-1 for API Gateway)"

    # First, check for wildcard certificate (*.domain.dev)
    WILDCARD_DOMAIN="*.${DOMAIN_NAME}"
    print_info "Searching for wildcard certificate: $WILDCARD_DOMAIN"

    WILDCARD_CERT=$(aws acm list-certificates \
        --region "$AWS_REGION" \
        --profile "$AWS_PROFILE" \
        --query "CertificateSummaryList[?DomainName=='$WILDCARD_DOMAIN'].CertificateArn" \
        --output text)

    if [[ -n "$WILDCARD_CERT" ]]; then
        # Verify certificate is validated and covers our API domain
        CERT_STATUS=$(aws acm describe-certificate \
            --certificate-arn "$WILDCARD_CERT" \
            --region "$AWS_REGION" \
            --profile "$AWS_PROFILE" \
            --query 'Certificate.Status' \
            --output text)

        CERT_SANS=$(aws acm describe-certificate \
            --certificate-arn "$WILDCARD_CERT" \
            --region "$AWS_REGION" \
            --profile "$AWS_PROFILE" \
            --query 'Certificate.SubjectAlternativeNames' \
            --output text)

        if [[ "$CERT_STATUS" == "ISSUED" ]]; then
            print_success "Found validated wildcard certificate: $WILDCARD_CERT"
            print_info "Certificate status: $CERT_STATUS"
            print_info "Covers domains: $CERT_SANS"
            CERT_ARN="$WILDCARD_CERT"
            return 0
        fi
    fi

    # Check for exact domain certificate
    print_info "Searching for certificate: $API_DOMAIN"

    EXACT_CERT=$(aws acm list-certificates \
        --region "$AWS_REGION" \
        --profile "$AWS_PROFILE" \
        --query "CertificateSummaryList[?DomainName=='$API_DOMAIN'].CertificateArn" \
        --output text)

    if [[ -n "$EXACT_CERT" ]]; then
        CERT_STATUS=$(aws acm describe-certificate \
            --certificate-arn "$EXACT_CERT" \
            --region "$AWS_REGION" \
            --profile "$AWS_PROFILE" \
            --query 'Certificate.Status' \
            --output text)

        if [[ "$CERT_STATUS" == "ISSUED" ]]; then
            print_success "Found validated certificate: $EXACT_CERT"
            print_info "Certificate status: $CERT_STATUS"
            CERT_ARN="$EXACT_CERT"
            return 0
        fi
    fi

    # No suitable certificate found
    print_error "No validated ACM certificate found for $API_DOMAIN"
    echo ""
    print_info "You need an ACM certificate in us-east-1 that covers $API_DOMAIN"
    print_info "Options:"
    print_info "  1. Use existing wildcard certificate (recommended)"
    print_info "  2. Request a new certificate:"
    echo ""
    print_info "     aws acm request-certificate \\"
    print_info "       --domain-name $API_DOMAIN \\"
    print_info "       --validation-method DNS \\"
    print_info "       --region us-east-1 \\"
    print_info "       --profile $AWS_PROFILE"
    echo ""
    print_info "After requesting, add the DNS validation record to Route53"
    print_info "Then run this script again"
    exit 1
}


get_cognito_config() {
    print_step "Looking Up Cognito Configuration"

    # List user pools
    print_info "Searching for Cognito User Pools..."

    USER_POOLS=$(aws cognito-idp list-user-pools \
        --max-results 10 \
        --region "$AWS_REGION" \
        --profile "$AWS_PROFILE" \
        --query 'UserPools[*].[Id,Name]' \
        --output text)

    if [[ -z "$USER_POOLS" ]]; then
        print_warning "No Cognito User Pools found"
        print_info "Create one first with: ./bin/setup-cognito"
        COGNITO_USER_POOL_ID="CHANGE_ME"
        COGNITO_CLIENT_ID="CHANGE_ME"
        return
    fi

    echo ""
    echo "Available User Pools:"
    echo "$USER_POOLS" | nl -w2 -s'. '
    echo ""

    # Auto-select if only one pool
    POOL_COUNT=$(echo "$USER_POOLS" | wc -l | tr -d ' ')
    if [[ "$POOL_COUNT" -eq 1 ]]; then
        COGNITO_USER_POOL_ID=$(echo "$USER_POOLS" | awk '{print $1}')
        print_success "Auto-selected: $COGNITO_USER_POOL_ID"
    else
        read -p "Select User Pool number (1-$POOL_COUNT): " pool_num
        COGNITO_USER_POOL_ID=$(echo "$USER_POOLS" | sed -n "${pool_num}p" | awk '{print $1}')
    fi

    if [[ -z "$COGNITO_USER_POOL_ID" ]]; then
        print_error "Invalid selection"
        exit 1
    fi

    print_info "User Pool ID: $COGNITO_USER_POOL_ID"

    # Get app clients
    print_info "Getting App Clients..."

    CLIENT_ID=$(aws cognito-idp list-user-pool-clients \
        --user-pool-id "$COGNITO_USER_POOL_ID" \
        --region "$AWS_REGION" \
        --profile "$AWS_PROFILE" \
        --query 'UserPoolClients[0].ClientId' \
        --output text)

    if [[ -z "$CLIENT_ID" || "$CLIENT_ID" == "None" ]]; then
        print_warning "No App Clients found for this User Pool"
        COGNITO_CLIENT_ID="CHANGE_ME"
    else
        COGNITO_CLIENT_ID="$CLIENT_ID"
        print_success "App Client ID: $COGNITO_CLIENT_ID"
    fi
}

generate_vault_config() {
    print_step "Generating Vault Configuration"

    cat > /tmp/backend-vault-config.yaml << EOF
# Backend API Configuration
# Add this to your aws/playbooks/vaults/config.yml file

backend_config:
  # SAM Configuration
  sam_template_path: "../backend.yaml"
  stack_name: "${ENVIRONMENT}-portfolio-backend-api"
  sam_s3_bucket: "$SAM_BUCKET_NAME"

  # Environment Configuration
  environment: "$ENVIRONMENT"

  # Cognito Configuration
  cognito_user_pool_id: "$COGNITO_USER_POOL_ID"
  cognito_client_id: "$COGNITO_CLIENT_ID"

  # Custom Domain Configuration
  custom_domain_name: "$API_DOMAIN"
  hosted_zone_id: "$HOSTED_ZONE_ID"
  certificate_arn: "$CERT_ARN"

  # CORS Configuration
  frontend_origins: "https://$DOMAIN_NAME,https://www.$DOMAIN_NAME"
EOF

    print_success "Vault configuration generated"
    echo ""
    print_info "Configuration saved to: /tmp/backend-vault-config.yaml"
    echo ""
    echo "────────────────────────────────────────────────────────────────"
    cat /tmp/backend-vault-config.yaml
    echo "────────────────────────────────────────────────────────────────"
    echo ""
}

add_to_vault() {
    local vault_file="$PLAYBOOKS_DIR/vaults/config.yml"

    if [[ ! -f "$vault_file" ]]; then
        print_warning "Vault file not found: $vault_file"
        return
    fi

    print_step "Adding Configuration to Vault"

    print_warning "This will decrypt, modify, and re-encrypt your vault"
    read -p "Continue? (y/n) " -n 1 -r
    echo

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_info "Skipped vault update"
        print_info "You can manually add the configuration from: /tmp/backend-vault-config.yaml"
        return
    fi

    # Decrypt vault
    print_info "Decrypting vault..."
    if ! ansible-vault decrypt "$vault_file"; then
        print_error "Failed to decrypt vault"
        return
    fi

    # Add backend config
    print_info "Adding backend configuration..."
    echo "" >> "$vault_file"
    cat /tmp/backend-vault-config.yaml >> "$vault_file"

    # Re-encrypt vault
    print_info "Re-encrypting vault..."
    if ansible-vault encrypt "$vault_file"; then
        print_success "Vault updated successfully"
    else
        print_error "Failed to re-encrypt vault"
        print_warning "Vault file is DECRYPTED. Please encrypt it manually:"
        print_info "  ansible-vault encrypt $vault_file"
    fi
}

show_summary() {
    print_step "Setup Summary"

    cat << EOF
Setup completed successfully! Here's what was configured:

SAM S3 Bucket:
  • Bucket: s3://$SAM_BUCKET_NAME
  • Region: $AWS_REGION
  • Versioning: Enabled

ACM Certificate:
  • Domain: $API_DOMAIN
  • ARN: $CERT_ARN
  • Region: $AWS_REGION

Route53:
  • Hosted Zone: $HOSTED_ZONE_ID
  • Domain: $DOMAIN_NAME

Cognito:
  • User Pool ID: $COGNITO_USER_POOL_ID
  • Client ID: $COGNITO_CLIENT_ID

Environment: $ENVIRONMENT

Next Steps:
  1. Verify certificate is validated:
     aws acm describe-certificate --certificate-arn $CERT_ARN --region $AWS_REGION

  2. Review vault configuration:
     cat /tmp/backend-vault-config.yaml

  3. Add configuration to vault:
     cd aws/playbooks
     ansible-vault decrypt vaults/config.yml
     # Add the configuration from /tmp/backend-vault-config.yaml
     ansible-vault encrypt vaults/config.yml

  4. Deploy backend:
     ./aws/bin/backend-sam-deploy --validate
     ./aws/bin/backend-sam-deploy

For more information, see:
  • aws/playbooks/BACKEND_DEPLOYMENT.md
  • aws/playbooks/BACKEND_VAULT_CONFIG.md

EOF
}

parse_arguments() {
    SKIP_BUCKET=false
    SKIP_CERT=false
    SKIP_VALIDATION=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_help
                exit 0
                ;;
            --region)
                AWS_REGION="$2"
                shift 2
                ;;
            --profile)
                AWS_PROFILE="$2"
                shift 2
                ;;
            --domain)
                DOMAIN_NAME="$2"
                API_DOMAIN="${API_SUBDOMAIN}.${DOMAIN_NAME}"
                shift 2
                ;;
            --api-subdomain)
                API_SUBDOMAIN="$2"
                API_DOMAIN="${API_SUBDOMAIN}.${DOMAIN_NAME}"
                shift 2
                ;;
            --env)
                ENVIRONMENT="$2"
                shift 2
                ;;
            --bucket)
                SAM_BUCKET_NAME="$2"
                shift 2
                ;;
            --skip-bucket)
                SKIP_BUCKET=true
                shift
                ;;
            --skip-certificate)
                SKIP_CERT=true
                shift
                ;;
            --skip-validation)
                SKIP_VALIDATION=true
                shift
                ;;
            *)
                print_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
}

main() {
    parse_arguments "$@"

    # Show banner
    echo ""
    echo "═══════════════════════════════════════════════════════════════════"
    echo "║   Cloud Resume Challenge - Backend Setup                       ║"
    echo "═══════════════════════════════════════════════════════════════════"
    echo ""
    print_info "Region: $AWS_REGION"
    print_info "Profile: $AWS_PROFILE"
    print_info "Domain: $DOMAIN_NAME"
    print_info "API Domain: $API_DOMAIN"
    print_info "Environment: $ENVIRONMENT"
    echo ""

    # Run setup steps
    check_prerequisites

    if [[ "$SKIP_BUCKET" != true ]]; then
        create_sam_bucket
    fi

    get_hosted_zone

    if [[ "$SKIP_CERT" != true ]]; then
        find_certificate
    fi

    get_cognito_config
    generate_vault_config

    # Optionally add to vault
    read -p "Add configuration to encrypted vault now? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        add_to_vault
    fi

    show_summary

    print_success "Setup complete!"
}

# Run main function
main "$@"

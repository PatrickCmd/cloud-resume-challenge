#!/usr/bin/env bash
set -euo pipefail

# ============================================
# Display Cognito Configuration Script
# ============================================
# This script displays the Cognito configuration from
# the output files generated by setup-cognito playbook

# Colors for output
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
OUTPUTS_DIR="${PROJECT_ROOT}/outputs"

# Function to print colored messages
print_info() {
    echo -e "${BLUE}ℹ ${1}${NC}"
}

print_success() {
    echo -e "${GREEN}✓ ${1}${NC}"
}

print_error() {
    echo -e "${RED}✗ ${1}${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ ${1}${NC}"
}

print_header() {
    echo -e "${CYAN}${1}${NC}"
}

# Function to print header
print_banner() {
    echo ""
    echo "╔════════════════════════════════════════════════════════════╗"
    echo "║        Cognito Configuration Viewer                       ║"
    echo "╚════════════════════════════════════════════════════════════╝"
    echo ""
}

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [OPTIONS]

Display Cognito User Pool configuration from output files.

OPTIONS:
    -h, --help              Show this help message
    -j, --json              Display JSON format only
    -e, --env               Display environment variables only
    -p, --show-password     Show temporary password (hidden by default)
    -c, --commands          Show useful AWS CLI commands

EXAMPLES:
    # Show all configuration
    $(basename "$0")

    # Show only JSON format
    $(basename "$0") --json

    # Show with password visible
    $(basename "$0") --show-password

    # Show useful commands
    $(basename "$0") --commands

FILES USED:
    - ${OUTPUTS_DIR}/cognito-config.json
    - ${OUTPUTS_DIR}/cognito-config.env

EOF
    exit 0
}

# Parse command line arguments
SHOW_JSON=false
SHOW_ENV=false
SHOW_PASSWORD=false
SHOW_COMMANDS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -j|--json)
            SHOW_JSON=true
            shift
            ;;
        -e|--env)
            SHOW_ENV=true
            shift
            ;;
        -p|--show-password)
            SHOW_PASSWORD=true
            shift
            ;;
        -c|--commands)
            SHOW_COMMANDS=true
            shift
            ;;
        *)
            print_error "Unknown option: $1"
            echo ""
            usage
            ;;
    esac
done

# If no specific format requested, show both
if [[ "$SHOW_JSON" == "false" ]] && [[ "$SHOW_ENV" == "false" ]] && [[ "$SHOW_COMMANDS" == "false" ]]; then
    SHOW_JSON=true
    SHOW_ENV=true
fi

print_banner

# ============================================
# Check if files exist
# ============================================

ENV_FILE="${OUTPUTS_DIR}/cognito-config.env"
JSON_FILE="${OUTPUTS_DIR}/cognito-config.json"

if [[ ! -f "$ENV_FILE" ]] && [[ ! -f "$JSON_FILE" ]]; then
    print_error "No Cognito configuration files found"
    print_info "Expected files:"
    echo "  - ${ENV_FILE}"
    echo "  - ${JSON_FILE}"
    echo ""
    print_info "Run the setup script first:"
    echo "  ./aws/bin/setup-cognito"
    echo ""
    exit 1
fi

# ============================================
# Display Environment Variables
# ============================================

if [[ "$SHOW_ENV" == "true" ]] && [[ -f "$ENV_FILE" ]]; then
    print_header "Environment Variables (cognito-config.env)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Read and display env file
    while IFS= read -r line; do
        # Skip comments and empty lines
        if [[ "$line" =~ ^#.*$ ]] || [[ -z "$line" ]]; then
            echo -e "${CYAN}${line}${NC}"
        elif [[ "$line" =~ TEMPORARY_PASSWORD= ]]; then
            # Handle password display
            if [[ "$SHOW_PASSWORD" == "true" ]]; then
                echo -e "${YELLOW}${line}${NC}"
            else
                echo -e "${YELLOW}TEMPORARY_PASSWORD=********** (hidden, use --show-password to reveal)${NC}"
            fi
        else
            echo "$line"
        fi
    done < "$ENV_FILE"

    echo ""
fi

# ============================================
# Display JSON Configuration
# ============================================

if [[ "$SHOW_JSON" == "true" ]] && [[ -f "$JSON_FILE" ]]; then
    print_header "JSON Configuration (cognito-config.json)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Pretty print JSON if jq is available
    if command -v jq &> /dev/null; then
        cat "$JSON_FILE" | jq '.'
    else
        cat "$JSON_FILE"
        echo ""
        print_warning "Install jq for better JSON formatting: brew install jq"
    fi

    echo ""
fi

# ============================================
# Display Useful Commands
# ============================================

if [[ "$SHOW_COMMANDS" == "true" ]]; then
    # Extract values from env file
    if [[ -f "$ENV_FILE" ]]; then
        USER_POOL_ID=$(grep "^COGNITO_USER_POOL_ID=" "$ENV_FILE" | cut -d'=' -f2)
        CLIENT_ID=$(grep "^COGNITO_CLIENT_ID=" "$ENV_FILE" | cut -d'=' -f2)
        AWS_REGION=$(grep "^AWS_REGION=" "$ENV_FILE" | cut -d'=' -f2)
        OWNER_EMAIL=$(grep "^OWNER_EMAIL=" "$ENV_FILE" | cut -d'=' -f2)

        print_header "Useful AWS CLI Commands"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""

        echo -e "${CYAN}# Describe User Pool${NC}"
        echo "aws cognito-idp describe-user-pool \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --region ${AWS_REGION}"
        echo ""

        echo -e "${CYAN}# List users in pool${NC}"
        echo "aws cognito-idp list-users \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --region ${AWS_REGION}"
        echo ""

        echo -e "${CYAN}# Get user details${NC}"
        echo "aws cognito-idp admin-get-user \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --username ${OWNER_EMAIL} \\"
        echo "  --region ${AWS_REGION}"
        echo ""

        echo -e "${CYAN}# Reset user password${NC}"
        echo "aws cognito-idp admin-set-user-password \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --username ${OWNER_EMAIL} \\"
        echo "  --password 'NewPassword123!' \\"
        echo "  --permanent \\"
        echo "  --region ${AWS_REGION}"
        echo ""

        echo -e "${CYAN}# Delete user${NC}"
        echo "aws cognito-idp admin-delete-user \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --username ${OWNER_EMAIL} \\"
        echo "  --region ${AWS_REGION}"
        echo ""

        echo -e "${CYAN}# Delete User Pool (after deleting domain)${NC}"
        echo "aws cognito-idp delete-user-pool \\"
        echo "  --user-pool-id ${USER_POOL_ID} \\"
        echo "  --region ${AWS_REGION}"
        echo ""
    fi
fi

# ============================================
# Security Warning
# ============================================

print_warning "Security Reminder:"
echo "  These files contain sensitive credentials!"
echo "  - Store the temporary password in a password manager"
echo "  - Delete these files after copying to backend/.env"
echo "  - Never commit these files to version control"
echo ""

print_info "Quick Actions:"
echo "  # Copy to backend .env"
echo "  cp ${OUTPUTS_DIR}/cognito-config.env backend/.env"
echo ""
echo "  # View with password"
echo "  $(basename "$0") --show-password"
echo ""
echo "  # Show useful commands"
echo "  $(basename "$0") --commands"
echo ""
